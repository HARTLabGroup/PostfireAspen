---
title: ""
author: "Sarah V. Carter and Sarah J. Hart"
email: "sarah.hart@colostate.edu"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output: 
   officedown::rdocx_document:
     reference_docx: Template.docx
bibliography: references.bib
csl: "`r here::here('citationstyle.csl')`"
link-citations: true
urlcolor: blue
linkcolor: blue
citationcolor: blue
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, dpi = 600, progress = FALSE, cache = FALSE, fig.width=5,  fig.height=3.5, fig.align="center", echo=F, eval=F)

set.seed(513)
options(repos = c(CRAN = "http://cran.rstudio.com"))
options(timeout=60*60*2) #timeout downloads that last longer than an hour
options(na.action = "na.fail")  

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, # easy file structure
  tidyverse, # data manipulation
  tidymodels, 
  ggplot2, # figures
  patchwork, # multiple figures
  readxl, # read excel files
  ggridges, # plotting
  ggcorrplot, # plotting
  lme4, # generalized linear mixed effects models
  effects, # plotting effects from glmms
  DHARMa, # evaluating residuals from glmms
  sjPlot, # extract glmm fit 
  stars, # raster data (new pkg)
  sf, # spatial data (new pkg)
  kableExtra # tables in markdown
) 

# Set custom plotting theme
theme_new <- function(base_size = 9,base_family = "Helvetica"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.line.x = element_line(color="black", size = 0.25),
      axis.line.y = element_line(color="black", size = 0.25),
      axis.title = element_text(size = 9),
      axis.text = element_text(colour="black", size=8),
      legend.key=element_rect(colour=NA, fill =NA),
      panel.grid = element_blank(),   
      plot.background = element_rect(fill = NA, colour = NA),
      panel.border = element_rect(fill = NA, colour = NA),
      panel.background = element_rect(fill = "white", colour = "black"), 
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 9)
      
    )
}
theme_set(theme_new())

options(ggplot2.continuous.colour="viridis")
options(scipen=999)

# Set directory structure for project
dir.create(here("Data"), showWarnings = FALSE)
dir.create(here("Data", "Spatial"), showWarnings = FALSE)
dir.create(here("Results"), showWarnings = FALSE)
```

# Introduction

## Research questions

1.  Where do aspen seedlings occur?

2.  Given seedling occurrence, what landscape factors explain aspen
    seedling density the number of stocked subplots (i.e. \>=1 seedling
    per subplot)?

3.  What landscape factors influence seedling height?

4.  What landscape and microsite factors, including competition with
    suckers, influence aspen seedling occurrence?

5.  What landscape and microsite factors, including competition with
    suckers, influence aspen seedling height?

We hypothesize: (A) seedlings will be more likely to occur when mature
aspen are not locally present, as seedlings are likely to be out compete
by root suckers [@kreider2021AspenSeedlingEstablishment]; (B) seedling
occurrence and density will be greater at higher elevations where soil
moisture is less limiting [@kreider2021AspenSeedlingEstablishment]; and
(C) microtopography will influence the accumulation of seedlings, as
concave microsite conditions will serve as a collection point for both
wind dispersed seeds and essential resources including water
[@kreider2021AspenSeedlingEstablishment].

# Methods

## Study area

We surveyed aspen seedling regeneration across forests that burned in
the 2020 Cameron Peak Fire located in Roosevelt National Forest,
northern central Colorado (Fig. 1). The Cameron Peak Fire was the
largest wildfire in Colorado history, with a total burn area of over
84,544 hectares and approximately five months of burn time from August -
December of 2020 (Swayze et al., 2021). The study area spans an
elevation gradient from 2519 m to 3259 m and is characterized by a
continental climate. However, the two spring periods following the fire
were notably high in precipitation, improving growing season conditions
for seedling establishment and survival in their most vulnerable stage
(Swayze et al., 2021).

Pre-fire forest composition and structure within the Cameron Peak burn
scar varied with elevation. Lower elevation zones below 2800 m were
characterized by dry and mesic montane forests, dominated by ponderosa
pine (*Pinus ponderosa*), with lesser components of Douglas-fir
(*Pseudotsuga menziesii*). Moderate and higher elevation stands between
approximately 2800 â€“ 3300 m were made up of mixed conifer subalpine
forest, dominated by Engelmann spruce (*Picea engelmannii*), subalpine
fir (*Abies lasiocarpa*), and lodgepole pine (*Pinus contorta*). (Swayze
et al., 2021).

```{r FigStudyArea, fig.cap="The study area", fig.height=4.5, fig.width=5, eval=T}
knitr::include_graphics(here("Results", "Figures", "FigStudyArea.jpg"))
```

## Field methods

### Sample sites

### Plot design and data collection

```{r importData}
# Site data
site.dat <- read_excel(here("Data", "Postfire-Regen.xlsx"), sheet="Site")
site.dat <- mutate_if(site.dat, is.character, as.factor) # change any character strings to factor
site.dat$Site <- as.factor(site.dat$Site) # change site no to factor

# Seedling density
seedlingdensity.dat <- read_excel(here("Data", "Postfire-Regen.xlsx"), sheet="SeedlingDensity")
seedlingdensity.dat <- mutate_if(seedlingdensity.dat, is.character, as.factor) # change any character strings to factor
seedlingdensity.dat$Site <- as.factor(seedlingdensity.dat$Site)

# Seedling microsite data
seedlingmicro.dat <- read_excel(here("Data", "Postfire-Regen.xlsx"), sheet="SeedlingMicrosite") 
seedlingmicro.dat <- mutate_if(seedlingmicro.dat, is.character, as.factor) # change any character strings to factor
seedlingmicro.dat$Site <- as.factor(seedlingmicro.dat$Site) # change site no to factor
seedlingmicro.dat$browse <- as.factor(seedlingmicro.dat$Browse) # change browse category to factor

# Site microsite data
sitemicro.dat <- read_excel(here("Data", "Postfire-Regen.xlsx"), sheet="SiteMicrosite") 
sitemicro.dat <- mutate_if(sitemicro.dat, is.character, as.factor) # change any character strings to factor
sitemicro.dat$Site <- as.factor(sitemicro.dat$Site) # change site no to factor

# Prefire overstory data
overstory <- read_excel(here("Data", "Postfire-Regen.xlsx"), sheet="PrefireOverstory") 
overstory <- mutate_if(overstory, is.character, as.factor) # change any character strings to factor
overstory$Site <- as.factor(overstory$Site) # change site no to factor
ABLA.prefire <- overstory %>% filter(ABLA==1) %>% pull(Site)
PICO.prefire <- overstory %>% filter(PICO==1) %>% pull(Site)
PIEN.prefire <- overstory %>% filter(PIEN==1) %>% pull(Site)
PIPO.prefire <- overstory %>% filter(PIPO==1) %>% pull(Site)
POTR5.prefire <- overstory %>% filter(POTR5==1) %>% pull(Site)
PSME.prefire <- overstory %>% filter(PSME==1) %>% pull(Site)
```

In the field, we recorded distance from plot center to the nearest
pre-fire live aspen. If distance exceeded 50 m, we measured the distance
from plot center to the nearest aspen using a 10-m gridded map of aspen
presence-absence for the study area produced by Cook et al. [in review].

```{r calcFoldedAspect}
library(DescTools)
# Convert site coordinates to spatial object
site.dat.sf <-  st_as_sf(site.dat, coords = c("Easting", "Northing"), crs = "EPSG:32613") %>% st_transform(crs="epsg:4326") 
site.dat$Longitude <- st_coordinates(site.dat.sf)[,1]
site.dat$Latitude <- st_coordinates(site.dat.sf)[,2]
# calculate folded aspect following McCune and Keon 2002
site.dat$FoldedAspect <- abs(180 - abs(site.dat$Aspect -225)) # calculate folded aspect
site.dat$HeatLoad <- (1 - cos(DescTools::DegToRad(site.dat$Aspect-45)))/2 # calculate heat load
site.dat$PotentialDirRad <- -1.467+1.582*cos(DegToRad(site.dat$Latitude))*cos(DegToRad(site.dat$Slope))-1.*cos(site.dat$FoldedAspect)* sin(DegToRad(site.dat$Slope))*sin(DegToRad(site.dat$Latitude))-0.262*sin(DegToRad(site.dat$Latitude))*sin(DegToRad(site.dat$Slope))+0.607* sin(site.dat$FoldedAspect)*sin(DegToRad(site.dat$Slope))

```

```{r calcAspenDist}
# Read in aspen presence/absence data
aspen <- read_stars(here("Data", "Spatial", "Aspen", "srme_skcv_distribution_binopt.tif"))

# Read in fire severity data
severity <-  read_stars(here('Data', 'Spatial', 'MTBS', 'composite_data', 'MTBS_BSmosaics', '2020', 'mtbs_CONUS_2020', 'mtbs_CONUS_2020.tif'))

# Read in perimeter data
CameronPeak <- st_read(here("Data", "Spatial", "MTBS", "mtbs_perims_DD.shp")) 

# Create polygon of the area burned at moderate to high severity
CameronPeak <- CameronPeak %>% 
  filter(Incid_Name == "CAMERON PEAK") %>% # pull out just Cameron Peak
  st_transform(st_crs(severity)) # transform 
  
CameronPeak.severity <- st_crop(severity, st_bbox(CameronPeak))
CameronPeak.highseverity <- st_as_sf(CameronPeak.severity[1], as_points = FALSE, merge =TRUE) %>%
  filter(mtbs_CONUS_2020.tif %in% 3:4) %>% # select only moderate and high severity pixels
  st_union() # combine into one polygon
st_write(CameronPeak.highseverity, here("Data", "Spatial", "MTBS", "CameronPeak-highseverity.shp"), append=F) # write to file

# Convert aspen data from raster to polygon
CameronPeak <- CameronPeak %>% 
st_transform(st_crs(aspen)) %>% # transform geometry to match aspen
  st_buffer(dist=5000) # buffer fire extent by 5 kilometers
aspen <- aspen %>% st_crop(st_bbox(CameronPeak)) # crop aspen data to area in and surrounding Cameron Peak

aspen.p <- st_as_sf(aspen[1], as_points = FALSE, merge =TRUE) 
aspen.p1 <- aspen.p %>%
  filter(srme_skcv_distribution_binopt.tif==1) %>% # select only presence polygons
  st_union() # combine presence polygons into one polygon
st_write(aspen.p1, here("Data", "Spatial", "Aspen", "aspen.shp"), append=F) # write to file

# Get area of live aspen
CameronPeak.highseverity <- st_read(here("Data", "Spatial", "MTBS", "CameronPeak-highseverity.shp")) %>% st_transform(st_crs(aspen.p1))
aspen.live <- st_difference(aspen.p1, CameronPeak.highseverity)
st_write(aspen.live, here("Data", "Spatial", "Aspen", "aspen-live.shp"), append=F) # write to file

# Calculate distance of each site to edge of polygon
aspen.live <- st_read(here("Data", "Spatial", "Aspen", "aspen-live.shp")) %>% st_transform(st_crs(site.dat.sf))
site.dat$geo.dist <- st_distance(site.dat.sf, aspen.live) %>% as.numeric()

# Create new column (dist) that uses field distances when distance to the nearest tree was measured as <=50 m in the field and geospatial distance when it was estimated as >=51 m
site.dat$dist <- site.dat$Dist.Live.Aspen
site.dat[site.dat$Dist.Live.Aspen>=51, "dist"] <- site.dat[site.dat$Dist.Live.Aspen>=51, "geo.dist"]
```

```{r}
site.dat.sf <-  st_as_sf(site.dat, coords = c("Easting", "Northing"), crs = "EPSG:32613")
CWD <- rast(here("Data", "Spatial", "Rodman", "AET and CWD", "CWD_1981-2010.tif"))
AET <- rast(here("Data", "Spatial", "Rodman", "AET and CWD", "AET_1981-2010.tif"))
site.dat.sf <- extract(CWD, site.dat.sf, bind=T)
site.dat.sf <- extract(AET, site.dat.sf, bind=T)
site.dat$AET <- site.dat.sf$AET_1981.2010
site.dat$CWD <- site.dat.sf$CWD_1981.2010
```

```{r summarizeTransectData}
# Calculate total number of seedlings per transect
seedlingdensity.transect <- seedlingdensity.dat %>% group_by(Site,Transect) %>% summarize_at(.vars=vars(ABLA:POTR5.seedling), .fun=sum)

# Determine if a plot is stocked (>=1 seedling)
stocking.transect <- seedlingdensity.dat %>% mutate_if(is.numeric, ~1 * (. != 0)) # convert any values >=1 to 1

# Calculate number of subplots with seedlings per transect
stocking.transect<- stocking.transect %>% group_by(Site, Transect) %>% summarize_at(.vars=vars(ABLA:POTR5.seedling), .fun=sum)

# Combine transect level data frames
seedlingdensity.transect  <- full_join(seedlingdensity.transect, stocking.transect,by=c('Site', 'Transect'), suffix=c(".density", ".stocking"))

# Create separate variable describing the presence and absence of aspen seedlings
seedlingdensity.transect$POTR5.seedling01 <- ifelse(seedlingdensity.transect$POTR5.seedling.density>0, 1,0) 
seedlingdensity.transect$POTR5.seedlingpa <- ifelse(seedlingdensity.transect$POTR5.seedling01==1, "presence","absence") %>% as.factor()

# Create separate variable describing the presence and absence of aspen suckers
seedlingdensity.transect$POTR5.sucker01 <- ifelse(seedlingdensity.transect$POTR5.sucker.density>0, 1,0) 
seedlingdensity.transect$POTR5.suckerpa <- ifelse(seedlingdensity.transect$POTR5.sucker01==1, "presence","absence") %>% as.factor()
```

```{r summarizeplot}
# Calculate total number of seedlings per transect
seedlingdensity.plot <- seedlingdensity.dat %>% group_by(Site) %>% summarize_at(.vars=vars(ABLA:POTR5.seedling), .fun=sum)

# Determine if a plot is stocked (>=1 seedling)
stocking.plot <- seedlingdensity.dat  %>% mutate_if(is.numeric, ~1 * (. != 0)) # convert any values >=1 to 1

# Calculate number of subplots with seedlings per transect
stocking.plot<- stocking.plot%>% group_by(Site) %>% summarize_at(.vars=vars(ABLA:POTR5.seedling), .fun=sum)

# Combine transect level data frames
seedlingdensity.plot  <- full_join(seedlingdensity.plot, stocking.plot,by=c('Site'), suffix=c(".density", ".stocking"))

# Create separate variable describing the presence and absence of aspen seedlings
seedlingdensity.plot$POTR5.seedling01 <- ifelse(seedlingdensity.plot$POTR5.seedling.density>0, 1,0) 
seedlingdensity.plot$POTR5.seedlingpa <- ifelse(seedlingdensity.plot$POTR5.seedling01==1, "presence","absence") %>% as.factor()

# Create separate variable describing the presence and absence of aspen suckers
seedlingdensity.plot$POTR5.sucker01 <- ifelse(seedlingdensity.plot$POTR5.sucker.density>0, 1,0) 
seedlingdensity.plot$POTR5.suckerpa <- ifelse(seedlingdensity.plot$POTR5.sucker01==1, "presence","absence") %>% as.factor()

# Convert to TPH
tph.fun <- function(x){x/(50*2)*10000}
seedlingdensity.tph <- seedlingdensity.dat %>% group_by(Site) %>% summarize_at(.vars=vars(ABLA:POTR5.seedling), .fun=sum) %>% mutate_if(is.numeric, tph.fun)
seedlingdensity.tph$Conifer <- rowSums(seedlingdensity.tph[,c("ABLA", "PICO", "PIEN", "PIPO", "PSME")])

```

```{r combinedData}
# Combine site and transect level data
compiled.site.transect <- right_join(site.dat,seedlingdensity.transect, by = "Site") 
compiled.site.plot <- right_join(site.dat,seedlingdensity.plot, by = "Site") 
```

For predictor variables, we tested (1) elevation, (2) slope, (3)
sine-transformed folded aspect, and (4) distance to pre-fire mature
aspen.

```{r setPredictorVarz}
select.continuous.varz <- c('Elevation', 'Slope', 'Aspect.rad.folded.sine', 'Dist')

select.continuous.varz.names <- c(
  `elevation`="elevation (m)",
  `abs.slope`="slope (degrees)",
  `aspect.rad.folded.sine`="sine-transformed folded aspect",
  `dist` = "distance to live aspen (m)"
)
```

## Data analysis

### Where do aspen seedlings occur?

#### Occurrence

To understand how landscape factors influence the occurrence of aspen
seedlings, we first modeled the presence/absence of aspen seedlings at
the transect level using a generalized linear mixed effect model (GLMM)
with a binomial-distributed error structure, a logit link, and a random
intercept of site identity nested within sample cluster.

##### Select variables

```{r}
p1 <- ggplot(compiled.site.transect, aes(x=factor(POTR5.seedling01, levels=c(0,1), labels=c("absent", "present"), ordered=T), y=dist))+geom_boxplot(outliers=F)+geom_jitter(aes(col=Cluster))+ylab("distance (m)")+xlab("seedling presence")
p2 <- ggplot(compiled.site.transect, aes(x=factor(POTR5.seedling01, levels=c(0,1), labels=c("absent", "present"), ordered=T), y=Elevation))+geom_boxplot(outliers=F)+geom_jitter(aes(col=Cluster))+ylab("elevation (m)")+xlab("seedling presence")
p3 <- ggplot(compiled.site.transect, aes(x=factor(POTR5.seedling01, levels=c(0,1), labels=c("absent", "present"), ordered=T), y=Slope))+geom_boxplot(outliers=F)+geom_jitter(aes(col=Cluster))+ylab("slope (degrees)")+xlab("seedling presence")
p4 <- ggplot(compiled.site.transect, aes(x=factor(POTR5.seedling01, levels=c(0,1), labels=c("absent", "present"), ordered=T), y=HeatLoad))+geom_boxplot(outliers=F)+geom_jitter(aes(col=Cluster))+ylab("sine transformed folded aspect")+xlab("seedling presence")
p5 <- ggplot(compiled.site.transect, aes(x=factor(POTR5.seedling01, levels=c(0,1), labels=c("absent", "present"), ordered=T), y=exp(PotentialDirRad)))+geom_boxplot(outliers=F)+geom_jitter(aes(col=Cluster))+ylab("potential direct radiation\n(MJ/sq. cm/yr)")+xlab("seedling presence")
p6 <- ggplot(compiled.site.transect, aes(x=factor(POTR5.seedling01, levels=c(0,1), labels=c("absent", "present"), ordered=T), y=AET))+geom_boxplot(outliers=F)+geom_jitter(aes(col=Cluster))+ylab("AET (mm/yr)")+xlab("seedling presence")
p7 <- ggplot(compiled.site.transect, aes(x=factor(POTR5.seedling01, levels=c(0,1), labels=c("absent", "present"), ordered=T), y=CWD))+geom_boxplot(outliers=F)+geom_jitter(aes(col=Cluster))+ylab("CWD (mm/yr)")+xlab("seedling presence")
p1 +p2+p3+p4+p5+p6+p7+plot_layout(guides="collect")
```

```{r fitOccurrence}
# first fit model with only random effects
occurrence.mod <- glmer(POTR5.seedling01 ~ (1|Site:Cluster), family=binomial, data=compiled.site.plot) 

# fit models with different combinations of predictors
modz <- list(
  update(occurrence.mod, ~ . + scale(dist)),
  update(occurrence.mod, ~ . + scale(Elevation)),
  update(occurrence.mod, ~ . + scale(Slope)),
  update(occurrence.mod, ~ . + scale(PotentialDirRad)),
  update(occurrence.mod, ~ . + scale(AET)),
  update(occurrence.mod, ~ . + scale(CWD))
)

# compile some summary statistics including AIC, likelihood ratio test statistic and p-value
occurrence.mod.summary <- do.call(rbind,lapply(lapply(modz, drop1, test="Chisq"), FUN=function(x){return(data.frame(variable=paste(row.names(x)[-1], collapse="+"), AIC=x$AIC[1], LRT=x$LRT[2], p=x[2,"Pr(Chi)"]))})) 

occurrence.mod.summary %>%  kable(digits=c(0,0,2, 3), caption="Summary statistics for models of aspen seedling occurrence") %>% kable_styling() 
```

##### Fit best model

*A common approach to selecting the best model given a set of candidate
models is to use the Akaike Information Criterion (AIC). AIC
incorporates both the number or variables, which generally improves
model fit but increases model complexity, and the maximum likelihood
estimate of the model, which describes how well the model reproduces the
data.*

```{r fitOccurrenceFinal}
occurrence.mod.final <- glmer(POTR5.seedling01 ~ scale(CWD) + (1|Site), family=binomial, data=compiled.site.plot)

tab_model(occurrence.mod.final)
```

##### Check residuals for best model

We used DHARMa package [@DHARMa] to test model residuals.

*Here if the data fits the model then the QQ plot (left) should show a
straight line and there should be no pattern between the residual and
the model predictions (right plot).*

```{r checkOccurrenceFinal, fig.width=7, fig.height=4, out.width="100%", fig.cap="Patterns in simulated residuals from the best fitting model of seedling occurrence."}
modfinal.binomial.simout <- simulateResiduals(occurrence.mod.final) # calculate randomized quantile residuals 
plot(modfinal.binomial.simout) 
# Read here for information: https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#binomial-data
```

##### Plot model effects for best model

To visualize the effect of predictor variables on the response, we
calculate the estimated marginal mean for the response while accounting
for other fixed and random effects using the Effects package
[@effects-2].

```{r effectsOccurrence, fig.cap="The estimated marginal mean probabiliy of seedling occurrence in transect by elevation and distance to pre-fire aspen. Shaded areas show the 95% confidence interval.", out.width="60%", fig.height=2.5, fig.width=3}
#effects.occurrence <- Effect(c("Elevation","dist"), occurrence.mod.final, xlevels=list(Elevation=seq(from=2400, to=3400, by=250), dist=c(seq(0,1000, by=250)))) %>% as.data.frame()
effects.occurrence <- Effect(c("CWD"), occurrence.mod.final, xlevels=list(CWD=seq(from=100, to=500, by=25))) %>% as.data.frame()
   
#gg.elevation <- ggplot(data=effects.occurrence)+geom_line(aes(x=Elevation, y=fit, col=factor(dist)))+geom_ribbon(aes(x=Elevation,ymin=lower,ymax=upper, fill=factor(dist)),alpha=0.2)+geom_point(data=compiled.site.transect, aes(x=Elevation, y=POTR5.seedling01))+xlab("elevation (m)")+ylab("Probabilty of\nseedling presence")+theme(legend.position="bottom")
#gg.elevation

gg.CWD <- ggplot(data=effects.occurrence)+geom_line(aes(x=CWD, y=fit))+geom_ribbon(aes(x=CWD,ymin=lower,ymax=upper),alpha=0.2)+geom_point(data=compiled.site.transect, aes(x=CWD, y=POTR5.seedling01, col=dist))+xlab("CWD (mm/yr)")+ylab("Probabilty of\nseedling presence")+theme(legend.position="bottom")
gg.CWD
```

#### Count

To understand how site conditions influence the count of seedlings
present, we modeled the total number of seedlings present within a plot
given occurrence. To account for the high variability in the count of
seedlings, we used a negative binomial GLMM and again included a random
intercept of site identity nested within sample cluster.

##### Select variables

```{r fitCount, eval=F}
count.mod <- glmer.nb(potr.seed.density ~  (1|site.no:cluster), data=compiled.site.transect[compiled.site.transect$potr.seed.density>=1,])

modz <- list(
  update(count.mod, ~ . + scale(dist)),
  update(count.mod, ~ . + scale(Elevation)),
  update(count.mod, ~ . + scale(Slope)),
  update(count.mod, ~ . + scale(PotentialDirRad)),
  update(count.mod, ~ . + scale(AET)),
  update(count.mod, ~ . + scale(CWD))
)

count.mod.summary <- do.call(rbind,lapply(lapply(modz, drop1, test="Chisq"), FUN=function(x){return(data.frame(variable=paste(row.names(x)[-1], collapse="+"), AIC=x$AIC[1], LRT=x$LRT[2], p=x[2,"Pr(Chi)"]))})) 

count.mod.summary %>%  kable(digits=c(0,0,2, 3), caption="Summary statistics for several models of aspen seedling density") %>% kable_styling() # note this just makes the table print pretty in html format. if you just want to look at the table without knitting the whole document you can just print the object
```

##### Fit best model

```{r fitCountFinal}
count.mod.final <-  glmer.nb(potr.seed.density ~ scale(dist) + (1|site.no:cluster), data=compiled.site.transect[compiled.site.transect$potr.seed.density>=1,])

tab_model(count.mod.final)
```

##### Check residuals for best model

We used DHARMa package [@DHARMa] to test model residuals.

*Here if the data fits the model then the QQ plot (left) should show a
straight line and there should be no pattern between the residual and
the model predictions (right plot)*

```{r checkCountFinal, fig.width=7, fig.height=4, out.width="100%", fig.cap="Patterns in simulated residuals from the best fitting model of the total number of aspen seedling present within a transect given occurrence."}
count.mod.final.simout <- simulateResiduals(count.mod.final) # calculate randomized quantile residuals 
plot(count.mod.final.simout) 
# Read here for information: https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#binomial-data
```

##### Plot model effects for best model

To visualize the effect of predictor variables on the response, we
calculate the estimated marginal mean for the response while accounting
for other fixed and random effects using the Effects package [@effects].

```{r effectsCount, fig.cap="The estimated marginal mean number of seedling in a transect by distance to pre-fire aspen. Shaded areas show the 95% confidence interval", out.width="60%", fig.height=2.5, fig.width=3}
effects.count <- Effect("dist", count.mod.final, xlevels=list(dist=seq(0,1000, by=500))) %>% as.data.frame()
  
gg.count <- ggplot()+geom_line(data=effects.count, aes(x=dist, y=fit))+geom_ribbon(data=effects.count, aes(x=dist,ymin=lower,ymax=upper),alpha=0.2)+geom_point(data=compiled.site.transect[compiled.site.transect$potr.seed.density>=1,], aes(x=dist, y=potr.seed.density, col=cluster))+xlab("distance (m)")+ylab("Seedling count")
gg.count
```

#### Stocking

To understand how site conditions influence the count of seedlings
present, we modeled the total number of seedlings present within a plot
given occurrence. To account for the high variability in the count of
seedlings, we used a negative binomial GLMM.

##### Select variables

```{r fitStocking}
stocking.mod <- glmer.nb(potr.seed.stocking ~  (1|site.no:cluster), data=compiled.site.transect[compiled.site.transect$potr.seed.density>=1,])

modz <- list(
  update(stocking.mod, ~ . + scale(dist)),
  update(stocking.mod, ~ . + scale(elevation)),
  update(stocking.mod, ~ . + scale(abs.slope)),
  update(stocking.mod, ~ . + scale(aspect.rad.folded.sine)),
  update(stocking.mod, ~ . + scale(dist)*scale(elevation)),
  update(stocking.mod, ~ . + scale(dist)*scale(abs.slope)),
  update(stocking.mod, ~ . + scale(dist)*scale(aspect.rad.folded.sine))
)

stocking.mod.summary <- do.call(rbind,lapply(lapply(modz, drop1, test="Chisq"), FUN=function(x){return(data.frame(variable=paste(row.names(x)[-1], collapse="+"), AIC=x$AIC[1], LRT=x$LRT[2], p=x[2,"Pr(Chi)"]))})) 
stocking.mod.summary%>%  kable(digits=c(0,0,2, 3), caption="Summary statistics for several models of the number of stocked subplots given seedling occurrence.") %>% kable_styling() # note this just makes the table print pretty in html format. if you just want to look at the table without knitting the whole document you can just print the stocking.mod.summary object


```

##### Fit best model

```{r fitStockingFinal}
stocking.mod.final <-  glmer.nb(potr.seed.stocking ~ scale(dist) + (1|site.no:cluster), data=compiled.site.transect[compiled.site.transect$potr.seed.density>=1,])
tab_model(stocking.mod.final)
```

##### Check residuals for best model

We used DHARMa package [@DHARMa] to test model residuals.

*Here if the data fits the model then the QQ plot (left) should show a
straight line and there should be no pattern between the residual and
the model predictions (right plot).*

```{r checkStockingFinal, fig.width=7, fig.height=4, out.width="100%", fig.cap="Patterns in simulated residuals from the best fitting model of the number of stocked subplots, given seedling presence."}
stocking.mod.final.simout <- simulateResiduals(stocking.mod.final) # calculate randomized quantile residuals 
plot(stocking.mod.final.simout) 
# Read here for information: https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#binomial-data
```

##### Plot model effects for best model

To visualize the effect of predictor variables on the response, we
calculate the estimated marginal mean for the response while accounting
for other fixed and random effects using the Effects package
[\@effects].

```{r effectsStocking, fig.cap="The estimated marginal mean the number of stocked plots in a transect given seedling presence by distance to pre-fire aspen. Shaded areas show the 95% confidence interval.", out.width="60%", fig.height=2.5, fig.width=3}
effects.stocking <- Effect("dist", stocking.mod.final, xlevels=list(dist=seq(0,1000, by=500)), residuals = TRUE) %>% as.data.frame()
  
gg.stocking <- ggplot()+geom_line(data=effects.stocking, aes(x=dist, y=fit))+geom_ribbon(data=effects.stocking, aes(x=dist,ymin=lower,ymax=upper),alpha=0.2)+geom_point(data=compiled.site.transect[compiled.site.transect$potr.seed.density>=1,], aes(x=dist, y=potr.seed.stocking))+xlab("distance (m)")+ylab("Count of subplots with seedlings present")
gg.stocking
```

#### Seedling height

To understand how site conditions influence the count of seedlings
present, we modeled the total number of seedlings present within a plot
given occurrence. To account for the high variability in the count of
seedlings, we used a negative binomial GLMM.

##### Select variables

```{r fitHeight}
height.mod <- lmer(log(height)~  (1|site.no:cluster), data= compiled.site.seedling)

modz <- list(
  update(height.mod, ~ . + scale(elevation)),
  update(height.mod, ~ . + scale(abs.slope)),
  update(height.mod, ~ . + scale(aspect.rad.folded.sine))
)

height.mod.summary <- do.call(rbind,lapply(lapply(modz, drop1, test="Chisq"), FUN=function(x){return(data.frame(variable=paste(row.names(x)[-1], collapse="+"), AIC=x$AIC[1], LRT=x$LRT[2], p=x[2,"Pr(Chi)"]))})) 
height.mod.summary %>%  kable(digits=c(0,0,2, 3), caption="Summary statistics for several models of aspen seedling height") %>% kable_styling() # note this just makes the table print pretty in html format. if you just want to look at the table without knitting the whole document you can just print the height.mod.summary object

```

##### Fit best model

```{r fitHeightFinal}
height.mod.final <-  lmer(log(height)~ browse+scale(elevation)+browse*scale(elevation)+(1|site.no:cluster), data= compiled.site.seedling)
tab_model(height.mod.final)
```

##### Check residuals for best model

We used DHARMa package [@DHARMa] to test model residuals.

*Here if the data fits the model then the QQ plot (left) should show a
straight line and there should be no pattern between the residual and
the model predictions (right plot).*

```{r checkHeightFinal, fig.width=7, fig.height=4, out.width="100%", fig.cap="Patterns in simulated residuals from the best fitting model of seedling height."}
height.mod.final.simout <- simulateResiduals(height.mod.final) # calculate randomized quantile residuals 
plot(height.mod.final.simout) 
# Read here for information: https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html
```

*Note this doesn't look like it fits super well. This may be because we
haven't included all of the relevant variables.*

##### Plot model effects for best model

To visualize the effect of predictor variables on the response, we
calculate the estimated marginal mean for the response while accounting
for other fixed and random effects using the Effects package
[\@effects].

```{r effectsHeight, fig.cap="The estimated marginal mean seedling height by elevation. Shaded areas show the 95% confidence interval.",out.width="60%", fig.height=2.5, fig.width=3}
effects.height <- Effect(c("elevation"), height.mod.final, xlevels=list(elevation=seq(from=2400, to=3400, by=100), dist=seq(0,1000, by=500)), residuals = TRUE) %>% as.data.frame()
   
gg.height <- ggplot()+geom_line(data=effects.height, aes(x=elevation, y=fit))+geom_ribbon(data=effects.height, aes(x=elevation,ymin=lower,ymax=upper),alpha=0.2)+geom_point(data=compiled.site.seedling, aes(x=elevation, y=log(height)))+xlab("elevation (m)")+ylab("Log of seedling height (cm)")

```

# Results

## Post-fire establishment within the Cameron Peak Fire

Across the `r nrow(site.dat)` sites sampled, we identified
`r nrow(seedlingmicro.dat)` total aspen seedlings, which were present at
66% of sites
`r round((seedlingdensity.plot %>% filter(POTR5.seedling.density>0) %>% nrow()) / nrow(site.dat) *100, 0)`
% (n=
`seedlingdensity.plot %>% filter(POTR5.seedling.density>0) %>% nrow()`
sites). Across plots where aspen seedlings were present, density was
highly variable and ranged between
`r seedlingdensity.tph %>% filter(POTR5.seedling>0) %>% pull(POTR5.seedling) %>% min()`
and ``` r seedlingdensity.tph``%>% pull(POTR5.seedling) %>% max() ```
seedlings per hectare. Within plots with aspen seedlings, their
distribution was also highly variable. Within these plots on average
`r (stocking.plot %>% filter(POTR5.seedling>0) %>% pull(POTR5.seedling) %>% mean()/ 50 *100) %>% round(1)`
% of the fifty 2 x 2 m subplots contained seedlings (mean:
`r stocking.plot %>% filter(POTR5.seedling>0) %>% pull(POTR5.seedling) %>% mean()  %>% round(1)`
subplots; range:
`r stocking.plot %>% filter(POTR5.seedling>0) %>% pull(POTR5.seedling) %>% min()` -
`r stocking.plot %>% filter(POTR5.seedling>0) %>% pull(POTR5.seedling) %>% max()`
subplots).

Conifer regeneration was much more limited, despite all plots being
located in stands that were dominated by conifers prior to fire. Two
years following fire we found
`r seedlingdensity.tph %>% pull(Conifer) %>% mean() %>% round(0)`
conifer seedlings per hectare. Pre-fire composition was an important
drivers of post-fire conifer seedling establishment (Fig.
@ref(fig:FigPostFireComp)). Lodgepole pine was present at
`r seedlingdensity.tph %>% filter(Site %in% PICO.prefire & PICO>0) %>% nrow()`
plots of the
`r seedlingdensity.tph %>% filter(Site %in% PICO.prefire) %>% nrow()`
plots was present prior to fire. Engelmann spruce was present
`r seedlingdensity.tph %>% filter(Site %in% PIEN.prefire & PIEN>0) %>% nrow()`
plot of the
`r seedlingdensity.tph %>% filter(Site %in% ABLA.prefire) %>% nrow()`
plots was present prior to fire.

```{r FigPostFireComp, fig.cap="The study area", fig.height=2.4, fig.width=3.5, eval=T}
# calculate the number of plots with seedlings present by species
x <- seedlingdensity.tph %>% 
  mutate(POTR5=sum(POTR5.seedling, POTR5.sucker)) %>% # calculate density of post-fire aspen seedlings and saplings
  pivot_longer(!Site) %>% # convert to long form
  mutate(presence=ifelse(value>0, 10, 0), ) %>% 
  filter(!name %in% c("Conifer", "POTR5.seedling", "POTR5.sucker")) # remove rows with aspen seedlings, aspen saplings, and conifers

# calculate the number of plots with overstory trees present by species
x2 <- overstory %>% 
  dplyr::select(-Cluster) %>% 
  pivot_longer(!Site) %>% 
  mutate(presence=ifelse(value>0, 1, 0))

x3 <- full_join(x2, x, by=c("Site", "name"), suffix=c(".pre", ".post")) %>%
  mutate_if(is.numeric, function(x){replace_na(x,0)}) %>% # replacing missing value with 0
  mutate(combo=presence.pre+presence.post) %>%
  mutate(combo=factor(combo, levels=c(0, 1, 10, 11), labels=c("absent pre- &\npost-fire", "present pre-fire &\nabsent post-fire", "absent pre-fire &\npresent pre-fire", "present pre- &\npost-fire")))  %>% 
  group_by(combo, name) %>% 
  summarise(freq=n())

gg.postfirecomp <- ggplot(x3, aes(x=name, y=freq, fill=combo))+geom_bar(stat="identity")+xlab("Species")+ylab("number of plots")+theme(legend.position = "bottom", legend.title = element_blank())+scale_fill_manual(values=c("grey", "#fc8d59", "#3288bd", "#99d594"))+guides(fill=guide_legend(nrow=2,byrow=TRUE))

# save plot
Fig.file <- here("Results", "Figures", "PostFireComposition.jpg")
ggsave(filename=Fig.file, plot=gg.postfirecomp, width=3.5, height=2.4, units="in", dpi=300)

knitr::include_graphics(here("Results", "Figures", "PostFireComposition.jpg"))
```

Subalpine fir was present
`r seedlingdensity.tph %>% filter(Site %in% ABLA.prefire & ABLA>0) %>% nrow()`
plot of the
`r seedlingdensity.tph %>% filter(Site %in% ABLA.prefire) %>% nrow()`
plots was present prior to fire. Engelmann spruce was present
`r seedlingdensity.tph %>% filter(Site %in% ABLA.prefire & ABLA>0) %>% nrow()`
plot of the
`r seedlingdensity.tph %>% filter(Site %in% ABLA.prefire) %>% nrow()`
plots was present prior to fire.

Two-years following the fire, spruce and fir regeneration was especially
low.

Subalpine fir was present
`r seedlingdensity.tph %>% filter(Site %in% ABLA.prefire & ABLA>0) %>% nrow()`
plot of the
`r seedlingdensity.tph %>% filter(Site %in% ABLA.prefire) %>% nrow()`
plots was present prior to fire. Engelmann spruce was present
`r seedlingdensity.tph %>% filter(Site %in% PIEN.prefire & PIEN>0) %>% nrow()`
plot of the
`r seedlingdensity.tph %>% filter(Site %in% PIEN.prefire) %>% nrow()`
plots was present prior to fire.

and averaged just over six seedlings per hectare for subalpine fir and
approximately 65 seedlings per hectare for Engelmann spruce across all
transects that contained these species pre-fire. We observed subalpine
fir seedlings at just one site, despite the presence of pre-fire fir at
24 sites. Lodgepole regeneration was relatively higher, at approximately
160 seedlings per hectare. Across the nine sites that contained pre-fire
ponderosa pine, we calculated mean regeneration to be approximately 83
seedlings per hectare. Only three sites contained pre-fire Douglas-fir,
with a mean regeneration of 50 seedlings per hectare.

# Supplemental materials

*Here are just some supplemental exploratory plots I made of your data.
Sorry, this code isn't annotated!*

## Exploratory plots

```{r}
compiled.site.transect %>%
  select(select.continuous.varz) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(hc.order = T, lab=T, lab_size=3, tl.cex=9)
```

### Relationships between predictor and cluster

```{r}
compiled.site.transect %>%
  select(c("cluster",select.continuous.varz)) %>%     pivot_longer(!cluster) %>%
  ggplot(aes(y=value, x=cluster))+geom_boxplot()+geom_jitter(width=0.25, size=0.5, col="blue3")+facet_wrap(.~name, scales="free_y", nrow=2, labeller=as_labeller(select.continuous.varz.names))+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### Relationships between response and predictor

```{r}
compiled.site.transect %>%
  select(c("potr.seedpa", all_of(select.continuous.varz))) %>%
  pivot_longer(!potr.seedpa) %>%
  ggplot(aes(x=potr.seedpa, y=value))+geom_boxplot()+geom_point(position=position_jitter(width=0.1,height=0), col="blue3", size=0.5)+facet_wrap(.~name,scale="free_y", labeller=as_labeller(select.continuous.varz.names), nrow=2)+xlab("presence of seedlings")
```

```{r}
compiled.site.transect %>% 
  filter(potr.seedpa=="presence") %>%
  select(c("potr.seed.density",select.continuous.varz)) %>%
  pivot_longer(!potr.seed.density) %>%
  ggplot(aes(y=log(potr.seed.density), x=value))+geom_point()+geom_smooth(method="lm")+facet_wrap(.~name, scales="free_x",labeller=as_labeller(select.continuous.varz.names), nrow=2)+ylab("log of total seedlings given presence")
```

```{r}
compiled.site.transect %>% 
  filter(potr.seedpa=="presence") %>%
  select(c("potr.seed.stocking",select.continuous.varz)) %>%
  pivot_longer(!potr.seed.stocking) %>%
  ggplot(aes(y=log(potr.seed.stocking), x=value))+geom_point()+geom_smooth(method="lm")+facet_wrap(.~name, scales="free_x",labeller=as_labeller(select.continuous.varz.names), nrow=2)+ylab("log of the number of stocked plots given presence")
```

# References
