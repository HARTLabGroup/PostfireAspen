---
title: "Site selection for postfire aspen project"
author: "Sarah Carter and Sarah Hart"
email: "Sarah.Hart@colostate.edu"
date: "June 16, 2022"
output: 
  bookdown::html_document2:
    code_folding: hide
    toc: TRUE
    toc_depth: 4
    toc_float: TRUE
    collapsed: TRUE
    theme: spacelab
    fig_caption: TRUE
    number_sections: FALSE
citationcolor: blue
csl: "`r here:::here('ecology.csl')`"
bibliography: "`r here:::here('MyLib.bib')`"
editor_options: 
  chunk_output_type: console
---

<style>h1 {font-size: 24pt; } h2 {font-size: 20pt; } h3 {font-size: 18pt; } h4 {font-size: 16pt; } h5 {font-size: 14pt; } h6 {font-size: 12pt; } </style>  

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, dpi = 600, progress = FALSE, cache = FALSE, fig.width=5,  fig.height=3.5, fig.align="center")

set.seed(513)
options(repos = c(CRAN = "http://cran.rstudio.com"))
options(timeout=60*60*2) #timeout downloads that last longer than an hour
options(na.action = "na.fail")  

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, # easy file structure
  tidyverse, # data manipulation
  tidymodels, 
  reshape, # old data manipulation pkg
  ggplot2, # figures
  patchwork, # multiple figures
  grid, # multiple figures
  ggsci, # color palettes
  colorspace, # color palettes
  RColorBrewer, # color palettes
  knitr, # markdown documents
  kableExtra, # tables in markdown
  flextable, # other table options
  bookdown, # figure numbering in markdown
  sp, # spatial data (old pkg)
  sf, # spatial data (new pkg)
  raster, # raster data (old pkg)
  fasterize, # quick polygon to raster
  stars, # raster data (new pkg)
  starsExtra, # extra raster functions
  tigris, # US Census bureau GIS data
  tmap # easy plotting of maps
) 


# Set custom plotting theme
theme_new <- function(base_size = 9,base_family = "Helvetica"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.line.x = element_line(color="black", size = 0.25),
      axis.line.y = element_line(color="black", size = 0.25),
      axis.title = element_text(size = 9),
      axis.text = element_text(colour="black", size=8),
      legend.key=element_rect(colour=NA, fill =NA),
      panel.grid = element_blank(),   
      plot.background = element_rect(fill = NA, colour = NA),
      panel.border = element_rect(fill = NA, colour = NA),
      panel.background = element_rect(fill = "white", colour = "black"), 
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 9)
      
    )
}
theme_set(theme_new())

options(ggplot2.continuous.colour="viridis")
options(scipen=999)

# Set directory structure for project
dir.create(here("Data/"), showWarnings = FALSE)
dir.create(here("Results/"), showWarnings = FALSE)
```

# Objective



# Download data
### Recent fires

MTBS Project. 2022. MTBS Data Access: Burned Area Boundaries Dataset. USDA Forest Service/U.S. Geological Survey.

```{r, eval=F}
dir.create(here("Data/Spatial/MTBS"), showWarnings = FALSE)
temp <- here("Data/Spatial/MTBS/MTBS.zip")
download.file("https://edcintl.cr.usgs.gov/downloads/sciweb1/shared/MTBS_Fire/data/composite_data/burned_area_extent_shapefile/mtbs_perimeter_data.zip", temp)
unzip(temp, exdir=here("Data/Spatial/MTBS/"))
```

MTBS Project. 2022. MTBS Data Access: 2020 Burn Severity Mosaic for CONUS . USDA Forest Service/U.S. Geological Survey.

Directly downloaded from https://www.mtbs.gov/direct-download and stored in the following directory - ~Data/Spatial/MTBS/composite_data/MTBS_BSmosaics/2020/mtbs_CONUS_2020. (Note I could not find a direct download link for this one).

### COMaP- Colorado Ownership, Management and Protection Database

Colorado Natural Heritage Program and the Geospatial Centroid. 2022. The Colorado Ownership and Protection Map (COMaP). Colorado State University, Ft. Collins, CO. 

Directly downloaded from https://cnhp.colostate.edu/projects/comap/ and stored in the following directory - ~Data/Spatial/CoMap. (This file is not publically available)


### CDOT Roads
Colorado Division of Transportation Development. 2020. Highways.
Colorado Division of Transportation Development. 2020. Local Roads.
Colorado Division of Transportation Development. 2020. Major Roads.

```{r download roads data, eval=F}
dir.create(here("Data/Spatial/Roads"), showWarnings = FALSE)
temp <- here("Data/Spatial/Roads/CO_HWY.zip")
download.file("http://dtdapps.coloradodot.info/staticdata/Downloads/StateGeoData/highways.zip", temp )
unzip(temp, exdir=here("Data/Spatial/Roads/"))

temp <- here("Data/Spatial/Roads/CO_LocalRoads.zip")
download.file("http://dtdapps.coloradodot.info/staticdata/Downloads/StateGeoData/LocalRoads.zip", temp )
unzip(temp, exdir=here("Data/Spatial/Roads/"))

temp <- here("Data/Spatial/Roads/CO_MajorRoads.zip")
download.file("http://dtdapps.coloradodot.info/staticdata/Downloads/StateGeoData/MajorRoads.zip", temp )
unzip(temp, exdir=here("Data/Spatial/Roads/"))
```

### USFS Roads data
```{r download roads data, eval=F}
dir.create(here("Data/Spatial/Roads"), showWarnings = FALSE)
temp <- here("Data/Spatial/Roads/S_USA.Road_MVUM.zip")
download.file("https://data.fs.usda.gov/geodata/edw/edw_resources/shp/S_USA.Road_MVUM.zip", temp )
unzip(temp, exdir=here("Data/Spatial/Roads/"))
```

### USFS Trails
```{r download trails data, eval=F}
dir.create(here("Data/Spatial/Trails"), showWarnings = FALSE)
temp <- here("Data/Spatial/Roads/S_USA.TrailNFS_Publish.zip")
download.file("https://data.fs.usda.gov/geodata/edw/edw_resources/fc/S_USA.TrailNFS_Publish.gdb.zip", temp )
unzip(temp, exdir=here("Data/Spatial/Trails/"))
```

### High resolution aspen cover

Cook and Balch (unpublished)
- This code will download a 10 m resolution map of aspen cover for the Southern Rocky Mountain Ecoregion, which extends from southern Wyoming to northern New Mexico. The map represents aspen cover in ca. 2019 and was produced from Sentinel imagery.

```{r, eval=F}
dir.create(here("Data/Spatial/Aspen"), showWarnings = FALSE)
temp <- here("Data/Spatial/Aspen/SRM_ASPEN_CLASSIFIED_RF_10M_V1_0522.tif")
download.file("https://drive.google.com/file/d/1uhV4rCJ6DM26HoyNU-emuh3rPxrR807Q/view?usp=sharing", temp )
```

### Elevation


LANDFIRE: LANDFIRE Elevation layer.
(2013, June - last update). U.S.
Department of Interior, Geological Survey, and U.S. Department of Agriculture.
[Online]. Available:
http://landfire.cr.usgs.gov/viewer/ [2020, J].
```{r, eval=F}
dir.create(here("Data/Spatial/Elev"), showWarnings = FALSE)
temp <- here("Data/Spatial/Elev/US_Topo_2020-LF2020_Elev_220_CONUS.zip")
download.file("https://landfire.gov/bulk/downloadfile.php?FNAME=US_Topo_2020-LF2020_Elev_220_CONUS.zip&TYPE=landfire", temp )
unzip(temp, exdir=here("Data/Spatial/Elev/"))

```

### Climate data
Rodman, K. C., T. T. Veblen, M. A. Battaglia, M. E. Chambers, P. J. Fornwalt, Z. A. Holden, T. E. Kolb, J. R. Ouzts, and M. T. Rother. 2020. A changing climate is snuffing out post‐fire recovery in montane forests. Global Ecology and Biogeography:geb.13174.

```{r download AET & CWD data, eval=F}
dir.create(here("Data/Spatial/Climate"), showWarnings = FALSE)
temp <- here("Data/Spatial/Climate/doi_10.5061_dryad.cz8w9gj1b__v2.zip")
download.file("https://datadryad.org/stash/downloads/file_stream/369982", temp )
unzip(temp, exdir=here("Data/Spatial/Climate/TraitBasedApproach_Rodman"))
```

### USFS Timber Harvest data
```{r download timber harvest data, eval=F}
dir.create(here("Data/Spatial/TimberHarvests"), showWarnings = FALSE)
temp <- here("Data/Spatial/TimberHarvests/TimberHarvests.zip")
download.file("https://data.fs.usda.gov/geodata/edw/edw_resources/fc/S_USA.Activity_TimberHarvest.gdb.zip", temp)
unzip(temp, exdir=here("Data/Spatial/TimberHarvests"))
```

### USFS Reforestation data
```{r download reforestation data, eval=F}
dir.create(here("Data/Spatial/Reforestation"), showWarnings = FALSE)
temp <- here("Data/Spatial/Reforestation/Reforestation.zip")
download.file("https://data.fs.usda.gov/geodata/edw/edw_resources/fc/S_USA.Activity_SilvReforestation.gdb.zip", temp)
unzip(temp, exdir=here("Data/Spatial/Reforestation"))
```

### USFS Fuel Treatment data
```{r download Fuel Treatment data, eval=F}
dir.create(here("Data/Spatial/FuelTreatment"), showWarnings = FALSE)
temp <- here("Data/Spatial/FuelTreatment/FuelTreatment.zip")
download.file("https://data.fs.usda.gov/geodata/edw/edw_resources/shp/S_USA.Activity_HazFuelTrt_PL.zip", temp)
unzip(temp, exdir=here("Data/Spatial/FuelTreatment"))
```

### USFS TSI data
```{r download Fuel Treatment data, eval=F}
dir.create(here("Data/Spatial/TSI"), showWarnings = FALSE)
temp <- here("Data/Spatial/TSI/TSI.zip")
download.file("https://data.fs.usda.gov/geodata/edw/edw_resources/fc/S_USA.Activity_SilvTSI.gdb.zip", temp)
unzip(temp, exdir=here("Data/Spatial/TSI"))
```

# Data processing

## Study area

1. Select areas of public land that burned at high severity
```{r}
fireseverity <-  read_stars(here("Data/Spatial/MTBS/composite_data/MTBS_BSmosaics/2020/mtbs_CONUS_2020/mtbs_CONUS_2020.tif"))

select.fires <- st_read(here("Data/Spatial/MTBS/mtbs_perims_DD.shp")) %>% 
  filter(Incid_Name %in% c("CALWOOD", "CAMERON PEAK", "EAST TROUBLESOME")) %>%
  st_transform(st_crs(fireseverity))  %>% 
  st_buffer(dist=-50)

fireseverity <- fireseverity %>% st_crop(st_bbox(select.fires)) %>%  st_as_sf( as_points = FALSE, merge =TRUE) 
highseverity <- fireseverity %>% filter(mtbs_CONUS_2020.tif==4) %>%  st_union()

comap <- st_read(here("Data/Spatial/CoMaP/COMAP-public.shp"))  %>%
  st_transform(st_crs(fireseverity))  # note for some reason I couldn't read the CoMAP data into R directly, so this datashet was generated by selecting all public land in QGIS
burned.public <- st_intersection(comap, highseverity)  %>% st_union()

st_write(burned.public, here("Data/Spatial/Sampling/HighSeverity-public.shp"))
```

2. Select roads that are easy enough to drive

```{r}
select.usfs.roads <- st_read(here("Data/Spatial/Roads/S_USA.Road_MVUM.shp")) %>% 
  filter(OPERATIONA %in% c("5 - HIGH DEGREE OF USER COMFORT", "4 - MODERATE DEGREE OF USER COMFORT", "3 - SUITABLE FOR PASSENGER CARS"))  %>%
  st_transform(st_crs(select.fires)) %>% # change projection
  st_crop(st_bbox(select.fires)) %>% # crop to study area
  st_union() 
```

```{r}
hwys <- rgdal::readOGR(here("Data/Spatial/Roads/SHP/STATEWIDE/Highways.shp")) %>% # note for some reason the sf package could not read in this file but rgdal could
  st_as_sf() %>% 
  st_zm() %>%
  st_transform(st_crs(select.fires)) %>% 
  st_crop(st_bbox(select.fires)) %>%  # crop to study area
  st_union()
local <- st_read(here("Data/Spatial/Roads/SHP/STATEWIDE/local_roads.shp")) %>%
  st_zm() %>%
  st_transform(crs=st_crs(select.fires))  %>% 
  st_crop(st_bbox(select.fires)) %>%  # crop to study area
  st_union()
major <- st_read(here("Data/Spatial/Roads/SHP/STATEWIDE/Major_Roads.shp")) %>%
  st_zm() %>% 
  st_transform(crs=st_crs(select.fires)) %>% 
  st_crop(st_bbox(select.fires)) %>%  # crop to study area
  st_union()
```

3. Trails

```{r}
trails <- st_read(here("Data/Spatial/Trails/Trails.shp")) %>%
  st_transform(st_crs(select.fires)) %>% 
  st_crop(st_bbox(select.fires)) 
```


4. Study area
Select areas of public land that:
1) burned at high severity
2) < 250 m away from the trail

```{r}
sf_use_s2(FALSE) # turn off spherical geometry

hwys1000 <- hwys %>% st_buffer(dist=1000)
major1000 <- major %>% st_buffer(dist=1000)
local1000 <- local %>% st_buffer(dist=1000)
select.usfs.roads1000 <- select.usfs.roads %>% st_buffer(dist=1000)
roadz1000 <- st_union(hwys1000, major1000) %>% st_union(local1000) %>% st_union(select.usfs.roads1000)

hwys500 <- hwys %>% st_buffer(dist=500)
major500 <- major %>% st_buffer(dist=500)
local500 <- local %>% st_buffer(dist=500)
select.usfs.roads500 <- select.usfs.roads %>% st_buffer(dist=500)
roadz500 <- st_union(hwys500, major500) %>% st_union(local500) %>% st_union(select.usfs.roads500)

hwys250 <- hwys %>% st_buffer(dist=250)
major250 <- major %>% st_buffer(dist=250)
local250 <- local %>% st_buffer(dist=250)
select.usfs.roads250 <- select.usfs.roads %>% st_buffer(dist=250)
roadz250 <- st_union(hwys250, major250) %>% st_union(local250) %>% st_union(select.usfs.roads250)

hwys100 <- hwys %>% st_buffer(dist=100)
major100 <- major %>% st_buffer(dist=100)
local100 <- local %>% st_buffer(dist=100)
select.usfs.roads100 <- select.usfs.roads %>% st_buffer(dist=100)
roadz100 <- st_union(hwys100, major100) %>% st_union(local100) %>% st_union(select.usfs.roads100)

hwys30 <- hwys %>% st_buffer(dist=30)
major30 <- major %>% st_buffer(dist=30)
local30 <- local %>% st_buffer(dist=30)
select.usfs.roads30 <- select.usfs.roads %>% st_buffer(dist=30)
roadz30<- st_union(hwys30, major30) %>% st_union(local30) %>% st_union(select.usfs.roads30)
```


```{r}
# identify trails that intersect roads
trail.id <- st_intersects(roadz30, trails)

trailz <- trails[trail.id[[1]],]
 
trailz <- trailz %>% st_buffer(dist=250) # buffer by 250 m
trailz2 <- st_intersection(trailz, roadz1000) # select part of trail within 1 km of a road
```


```{r}
accessible <- st_union(trailz2, roadz100)

burned.public.accessible <- st_intersection(accessible, burned.public)  %>% st_union()
st_write(burned.public.accessible, here("Data/Spatial/Sampling/burned-public-accessible.shp"))
```

## Aspen data
Convert aspen data to a polygon to select areas with aspen 
```{r}
aspen <- read_stars(here("Data/Spatial/Aspen/SRM_ASPEN_CLASSIFIED_RF_10M_V1_0522.tif"))
bb <- st_transform(select.fires, st_crs(aspen))
aspen <- aspen %>% st_crop(st_bbox(bb))

aspen.p <- st_as_sf(aspen[1], as_points = FALSE, merge =TRUE) 

aspen.p1 <- aspen.p %>%
  filter(SRM_ASPEN_CLASSIFIED_RF_10M_V1_0522.tif==1) %>% 
  st_transform(st_crs(burned.public.accessible)) %>% 
  st_union()

st_write(aspen.p1, here("Data/Spatial/Aspen/aspen.shp"), append=F)
```

## Select areas of public land that burned that are accessible with aspen
```{r}
burned.public.accessible.withaspen <- st_intersection(burned.public.accessible, aspen.p1)  %>% st_union()
st_write(burned.public.accessible.withaspen, here("Data/Spatial/Sampling/SamplingAreaAspen.shp"))
```

## Select areas of public land that burned that are accessible that are > 100 m from aspen but less than 500 and 1000 m
```{r}
burned.public.accessible.withaspen  <- st_read(here("Data/Spatial/Sampling/SamplingAreaAspen.shp"))

burned.public.accessible.withaspen.100 <- burned.public.accessible.withaspen %>%
  st_buffer(dist=500) %>% # buffer by 100 m
  st_union() %>% 
  st_intersection(burned.public.accessible) %>% 
  st_union()
st_write(burned.public.accessible.withaspen.100, here("Data/Spatial/Sampling/SamplingAreaAspen100m.shp"))

burned.public.accessible.withaspen.500 <- burned.public.accessible.withaspen %>% st_buffer(dist=500) %>% # buffer by 500 m
  st_union() %>% 
  st_intersection(burned.public.accessible) %>% 
  st_union()
st_write(burned.public.accessible.withaspen.500, here("Data/Spatial/Sampling/SamplingAreaAspen500m.shp"))

burned.public.accessible.withaspen.1000 <- burned.public.accessible.withaspen %>% st_buffer(dist=1000) %>% # buffer by 1000 m
  st_union() %>% 
  st_intersection(burned.public.accessible) %>% 
  st_union()
st_write(burned.public.accessible.withaspen.1000, here("Data/Spatial/Sampling/SamplingAreaAspen1000m.shp"))

burned.public.accessible.withnoaspen100.500 <- st_difference(burned.public.accessible.withaspen.500,burned.public.accessible.withaspen.100) %>% 
  st_union() %>% 
  st_sf() %>% # make the geometry a data frame object
  mutate(values = 500)
st_write(burned.public.accessible.withnoaspen1000, here("Data/Spatial/Sampling/SamplingAreaAspen100-500m.shp"))

burned.public.accessible.withnoaspen500.1000 <- st_difference(burned.public.accessible.withaspen.1000,burned.public.accessible.withaspen.100 ) %>% 
  st_union() %>% 
  st_sf() %>% # make the geometry a data frame object
  mutate(values = 1000)
st_write(burned.public.accessible.withnoaspen500.1000, here("Data/Spatial/Sampling/SamplingAreaAspen500-1000m.shp"))

sampleareaz <- rbind(burned.public.accessible.withnoaspen100.500, burned.public.accessible.withnoaspen500.1000)

# create regular sample
sampleareaz.grid <- as(make_grid(sampleareaz, res=250), "Raster")
sampleareaz.grid  <- fasterize(sampleareaz, sampleareaz.grid , field="values")
sampleareaz.pts <- st_as_sf(raster::rasterToPoints(sampleareaz.grid, spatial=T))
```


```{r}
## Assign aet, cwd, elevation, watershed identity, and aspen suitability
aetr <-  read_stars(here("Data/Spatial/Climate/TraitBasedApproach_Rodman/AET and CWD/AET_1981-2010.tif"))
cwdr <-  read_stars(here("Data/Spatial/Climate/TraitBasedApproach_Rodman/AET and CWD/CWD_1981-2010.tif"))
elevr <- read_stars(here("Data/Spatial/Elev/LF2020_Elev_220_CONUS/Tif/LC20_Elev_220.tif"))
aspen.suitability <- read_stars(here("Data/Spatial/Aspen/AspenDistribution/Coops-AspenModeledFreq1950-2006.tif"))
watershed <- st_read(here("Data/Spatial/Watershed/WBDHU12/WBDHU12.shp"))

xaetr <- st_extract(aetr, st_transform(sampleareaz.pts, st_crs(aetr)))
xcwdr <- st_extract(cwdr, st_transform(sampleareaz.pts, st_crs(cwdr)))
xelevr <- st_extract(elevr, st_transform(sampleareaz.pts, st_crs(elevr)))
xaspen.suitability <- st_extract(aspen.suitability, st_transform(sampleareaz.pts, st_crs(aspen.suitability)))
xwater <- st_join(st_transform(sampleareaz.pts, st_crs(watershed)), watershed)
xfire <- st_join(st_transform(sampleareaz.pts, st_crs(select.fires)), select.fires)

sampleareaz.pts.latlon <- st_transform(sampleareaz.pts, CRS("+init=epsg:4269"))
sampleareaz.pts <- sampleareaz.pts %>% mutate(Lat = st_coordinates(sampleareaz.pts.latlon)[,2], Lon =st_coordinates(sampleareaz.pts.latlon)[,1], Easting=st_coordinates(sampleareaz.pts)[,1], Northing= st_coordinates(sampleareaz.pts)[,2], Fire = xfire$Incid_Name, Watershed = xwater$Name, AET = xaetr$`AET_1981-2010.tif`, CWD=xcwdr$`CWD_1981-2010.tif`, Elev = xelevr$LC20_Elev_220.tif, Suitability=xaspen.suitability$`Coops-AspenModeledFreq1950-2006.tif`)

```

# Select 
```{r}
cp.pts <- sampleareaz.pts %>%  filter(Fire== "CAMERON PEAK")
#cp.pts025 <- cp.pts %>%  filter(Elev >quantile(cp.pts$Elev)[1] & Elev <quantile(cp.pts$Elev)[2]) %>% sample_n(20) %>% mutate(Elev.class = "low")

#cp.pts2550 <- cp.pts %>%  filter(Elev >quantile(cp.pts$Elev)[2] & Elev <quantile(cp.pts$Elev)[3]) %>% sample_n(20) %>% mutate(Elev.class = "low-moderate")

#cp.pts5075 <- cp.pts %>%  filter(Elev >quantile(cp.pts$Elev)[3] & Elev <quantile(cp.pts$Elev)[4])  %>% sample_n(20) %>% mutate(Elev.class = "moderate-high")

#cp.pts75100 <- cp.pts %>%  filter(Elev >quantile(cp.pts$Elev)[4] & Elev <quantile(cp.pts$Elev)[5]) %>% sample_n(20) %>% mutate(Elev.class = "high")

#cp.pts <- rbind(rbind(rbind(cp.pts025, cp.pts2550), cp.pts5075), cp.pts75100)
st_write(cp.pts, here("Data/Spatial/Sampling/Sampleptz-CP.shp"), append=F)
write.csv(as.data.frame(cp.pts), here("Data/Spatial/Sampling/Sampleptz.csv"))
```


