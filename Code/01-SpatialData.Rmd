---
title: "Spatial data for: "
author: "Sarah V. Carter and Sarah J. Hart"
email: "sarah.hart@colostate.edu"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output: 
   officedown::rdocx_document:
     reference_docx: Template.docx
bibliography: references.bib
csl: "`r here::here('citationstyle.csl')`"
link-citations: true
urlcolor: blue
linkcolor: blue
citationcolor: blue
---

```{r setup,include=FALSE, results='hide'}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	progress = FALSE,
	cache = FALSE,
	dpi = 300,
  fig.align = 'center'
)

set.seed(513)
options(repos = c(CRAN = "http://cran.rstudio.com"))
options(timeout=60*60) # timeout downloads that last longer than an hour

### Import libraries
if (!require("remotes"))  install.packages("remotes")
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, # easy file structure
  rmarkdown, # 
  flextable, # tables
  officer, # word documents
  bookdown, # word documents
  tidyverse, # data manipulation
  ggplot2, # figures
  RColorBrewer, # color palettes
  patchwork, # combining figures
  sf, # spatial data
  terra, # raster data
  tidyterra, # raster data
  stars, # raster data
  tmap, # easy plotting of maps
  terrainr, # dem
  prism, # prism data
  tmaptools, # helper library for tmap
  grid, # useful for plotting inset map
  prism, # prism data
  readxl # read excel files
) 

proj.proj <- 4629

# Set custom plotting theme
theme_new <- function(base_size = 9,base_family = "Helvetica"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.line.x = element_line(color="black", linewidth = 0.25),
      axis.line.y = element_line(color="black", linewidth = 0.25),
      axis.title = element_text(size = 9),
      axis.text = element_text(colour="black", size=8),
      legend.key=element_rect(colour=NA, fill =NA),
      panel.grid = element_blank(),   
      plot.background = element_rect(fill = NA, colour = NA),
      panel.border = element_rect(fill = NA, colour = NA),
      panel.background = element_rect(fill = "white", colour = "black"), 
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 9)
      
    )
}
theme_set(theme_new())

set_flextable_defaults(
  font.family="Times", 
  font.size=12,
  line_spacing=1,
  padding.bottom=1,
  padding.top=1,
  text.align='center')

# Set directory structure for project
dir.create(here("Data", "Spatial"), showWarnings = FALSE)
dir.create(here("Results"), showWarnings = FALSE)
dir.create(here("Results", "Figures"), showWarnings = FALSE)
```

# Overview

The following code will download nearly all publicly-available spatial data used in this study. Where data is not publicly-available or easy to programmatically download, we provide more details about how to access the data.

# Spatial data

## Basic Geographic data

We obtained spatial data describing state boundaries from the US Census Bureau (<https://www.census.gov/geographies/mapping-files.html>).

```{r DL_States, echo=T}
# states
dir.create(here("Data", "Spatial", "States"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "States", "cb_2018_us_state_20m.zip")
if(!file.exists(temp)){
  download.file("https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_us_state_20m.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "States"))
}
```

## Disturbance data

We acquired polygon data describing the extent and severity of the Cameron Peak fire from the Monitoring Trends in Burn Severity Project [@mtbsproject2024MTBSDataAccess; @mtbsproject2024MTBSDataAccessa] ([mtbs.gov](mtbs.gov)).

```{r DL_MTBS, echo=T}
# MTBS 
dir.create(here("Data", "Spatial", "MTBS"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "MTBS", "mtbs_perimeter_data.zip")
if(!file.exists(temp)){
  download.file("https://edcintl.cr.usgs.gov/downloads/sciweb1/shared/MTBS_Fire/data/composite_data/burned_area_extent_shapefile/mtbs_perimeter_data.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "MTBS"))
}

# MTBS burn severity
dir.create(here("Data", "Spatial", "MTBS"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "MTBS", "mtbs_CO_2020.zip")
if(!file.exists(temp)){
  drive_download(
  file="https://drive.google.com/file/d/1uj9QeBrZjSdhlf4ILtTglvWXlK2tfTha/view?usp=sharing",
  path = temp,
  overwrite = TRUE
  )
  unzip(temp, exdir=here("Data", "Spatial", "MTBS"))
  
}
```

We also obtained spatially data describing land ownership from the Colorado Natural Heritage Program [-@coloradonaturalheritageprogram2019ColoradoOwnershipManagement].

```{r DL_USFS}
dir.create(here("Data", "Spatial", "SUFS"), showWarnings = FALSE)
temp <- here(paste0("Data", "Spatial", "USFS", "RangerDistricts.zip"))
if(!file.exists(temp)){
  download.file("https://data.fs.usda.gov/geodata/edw/edw_resources/shp/S_USA.RangerDistrict.zip", temp)
  unzip(temp, exdir=here("Data", "Spatial", "USFS"))
}

```

```{r DL_LandOwnership}
dir.create(here("Data", "Spatial", "CoMaP"), showWarnings = FALSE)
temp <- here(paste0("Data", "Spatial", "CoMaP", "COMaP_v20190306.gdb.zip"))
if(!file.exists(temp)){
  drive_download(
  file="https://drive.google.com/file/d/1lJVJlDVQmXX9n67mG1a4lTys9D8WPmBg/view?usp=sharing",
  path = temp,
  overwrite = TRUE
  )
  unzip(temp, exdir=here("Data", "Spatial", "CoMaP"))
}

```

We obtained a 10-m resolution map of aspen cover in ca. 2019 from Cook et al. [-@cook2024MappingQuakingAspen].

```{r DL_aspen}
# Download spatial data describing the extent of aspen
if(!dir.exists(here("Data", "Spatial", "Aspen"))){
  dir.create(here("Data", "Spatial", "Aspen"), showWarnings = FALSE)
  temp <- here("Data", "Spatial", "Aspen","srme_skcv_distribution_binopt.tif")
 
  drive_download(
  file="https://drive.google.com/file/d/1u45jPgRgieC84a7yhTswQfdUn_--129B/view?usp=sharing",
  path = temp,
  overwrite = TRUE
  )
}
```

## Digital Elevation Model

We obtained a 250 m resolution Digital Elevation Model (DEM) for the study area from the National Elevation Dataset (NED) using the *terrainr* package [@terrainr].

```{r DEM, echo=T}
if(!file.exists(here("Data", "Spatial", "DEM", "DEM30.tif"))){
 # Read in perimeter data
CameronPeak <- st_read(here("Data", "Spatial", "MTBS", "mtbs_perims_DD.shp")) %>% 
  filter(Incid_Name == "CAMERON PEAK")  %>% st_transform(crs=5071) %>% st_buffer(20000)
  dir.create(here("Data", "Spatial","DEM"), showWarnings = FALSE)

 # 30 m 
  dem <- get_tiles(data=CameronPeak, output_prefix = here("Data", "Spatial", "DEM", "DEM30"), services="elevation",   resolution=30)
  dem.rast <- rast(dem$elevation)
  writeRaster(dem.rast, here("Data", "Spatial", "DEM", "DEM30.tif"), overwrite=T)
}
```

## PRISM

To characterize the study area's climate, we obtained monthly precipitation totals, minimum temperatures, and maximum temperature 30-year normals (1980-2010) from PRISM [@prismclimategroup2021Monthly30yearClimate] using the *prism* package [@prism]

```{r DL_PRISM, echo=T}
if(!dir.exists(here("Data", "Spatial", "PRISM"))){
  dir.create(here("Data", "Spatial", "PRISM"), showWarnings = FALSE)
  prism_set_dl_dir(here("Data", "Spatial", "PRISM"))
  
  # Climate normals
  get_prism_normals("ppt", "800m", annual = TRUE, keepZip = FALSE)
  get_prism_normals("ppt", "4km", mon=3:5, keepZip = FALSE)
  get_prism_normals("tmin", "800m", mon=1, keepZip = FALSE)
  get_prism_normals("tmax", "800m", mon=7, keepZip = FALSE)
  
  # Weather 2020, 2021 and 2022
  get_prism_annual("ppt", years=2020:2022, keepZip = FALSE)
  get_prism_monthlys("ppt", years=2020:2022, mon=1:12, keepZip = FALSE)
  get_prism_monthlys("tmax", years=2020:2022, mon=1:12, keepZip = FALSE)
}
```

# Generate study area map

```{r LiveAspen}
dir.create(here("Data", "Spatial", "Processed"))

# Read in aspen presence/absence data
aspen <- rast(here("Data", "Spatial", "Aspen", "srme_skcv_distribution_binopt.tif"))

# Read in fire severity data
severity <-  rast(here('Data', 'Spatial', 'MTBS', 'mtbs_CO_2020.tif'))

# Read in perimeter data
CameronPeak <- st_read(here("Data", "Spatial", "MTBS", "mtbs_perims_DD.shp")) %>% 
  filter(Incid_Name == "CAMERON PEAK") %>% # pull out just Cameron Peak
  st_transform(st_crs(severity)) # transform 

# Buffer fire by 5 km
CameronPeak.buffer5000 <- CameronPeak %>% 
  st_buffer(dist=5000)

# Clip severity raster 
CameronPeak.severity <- crop(severity, st_bbox(CameronPeak.buffer5000))

# Convert to polygon
CameronPeak.highseverity.p <- CameronPeak.severity %>% 
  st_as_stars() %>% 
  st_as_sf(as_points = FALSE, merge =TRUE) %>%
  filter(mtbs_CO_2020 %in% 4) %>% # select only high severity pixels
  st_union() # union
st_write(CameronPeak.highseverity.p, dsn=here("Data", "Spatial", "Processed", "CameronPeak-highseverity.shp"), append=F) # write to file

CameronPeak.highmodseverity.p <- CameronPeak.severity %>% 
  st_as_stars() %>% 
  st_as_sf(as_points = FALSE, merge =TRUE) %>%
  filter(mtbs_CO_2020 %in% 3:4) %>% # select only moderate and high severity pixels
  st_union() # union
st_write(CameronPeak.highmodseverity.p, dsn=here("Data", "Spatial", "Processed", "CameronPeak-highmod.shp"), append=F) # write to file


# Convert aspen data from raster to polygon
aspen <- aspen %>% crop(st_bbox(st_transform(CameronPeak.buffer5000, st_crs(aspen)))) # crop aspen data to area in and surrounding Cameron Peak
aspen.p <- aspen %>% 
  st_as_stars() %>% 
  st_as_sf(as_points = FALSE, merge =TRUE) %>%
  filter(Band_1==1) %>% 
  st_union(append=F) # union
st_write(aspen.p, dsn=here("Data", "Spatial", "Processed", "Aspen-CameronPeak.shp"),append=F)
aspen.r <- rasterize(st_as_sf(aspen.p), aspen, filename=here("Data", "Spatial", "Processed", "Aspen-total.tif"), overwrite=T)

# Get area of live aspen --> exclude aspen that burned at high severity
CameronPeak.highseverity.p <- CameronPeak.highseverity.p %>% st_transform(st_crs(aspen.p))
aspen.live.high <- st_difference(aspen.p, CameronPeak.highseverity.p)
st_write(aspen.live.high, here("Data", "Spatial", "Processed", "aspen-live-high.shp"), append=F) # write to file
aspen.live.high.r <- rasterize(st_as_sf(aspen.live.high), aspen, filename=here("Data", "Spatial", "Aspen", "Aspen-live-high.tif"), overwrite=T)

# Get area of live aspen --> exclude aspen that burned at modeate or high severity
CameronPeak.highmodseverity.p <- CameronPeak.highmodseverity.p  %>% st_transform(st_crs(aspen.p))
aspen.live.highmod <- st_difference(aspen.p, CameronPeak.highmodseverity.p)
st_write(aspen.live.highmod, here("Data", "Spatial", "Processed", "aspen-live-highmod.shp"), append=F) # write to file
aspen.live.highmod.r <- rasterize(st_as_sf(aspen.live.highmod), aspen, filename=here("Data", "Spatial", "Aspen", "Aspen-live-highmod.tif"), overwrite=T)

# Calculate distance
aspen.distance <- distance(aspen.r, filename=here("Data", "Spatial", "Processed", "aspen-dist.tif"), overwrite=T)
aspen.live.high.distance <- distance(aspen.live.high.r, filename=here("Data", "Spatial","Processed", "aspen-live-high-dist.tif"), overwrite=T)
aspen.live.highmod.distance <- distance(aspen.live.highmod.r, filename=here("Data", "Spatial","Processed", "aspen-live-highmod-dist.tif"), overwrite=T)
```

# Characterize study area

```{r CharacterizeClimate}
# Read in fire severity data
severity <-  rast(here('Data', 'Spatial', 'MTBS', 'mtbs_CO_2020.tif')) 
CameronPeak <-  st_read(here("Data", "Spatial", "MTBS", "mtbs_perims_DD.shp"))  %>% 
  filter(Incid_Name == "CAMERON PEAK") %>% # pull out just Cameron Peak
  st_transform(st_crs(severity)) # transform 
CameronPeak.severity <- crop(severity, st_bbox(CameronPeak ))
CameronPeak.severity[CameronPeak.severity >=5] <-NA
  
# Read in aspen data
aspen <- rast(here("Data", "Spatial", "Aspen", "srme_skcv_distribution_binopt.tif"))
aspen.live.distance <- rast(here("Data", "Spatial","Processed", "aspen-live-highmod-dist.tif"))
aspen.prefire.distance <- rast(here("Data", "Spatial", "Processed", "aspen-dist.tif"))

# Read in elevation data
dem <- rast(here("Data", "Spatial", "DEM", "DEM30.tif"))

# Read in climate data
prism_set_dl_dir(here("Data", "Spatial", "PRISM"))

#normals
ppt.normal <- prism_archive_subset("ppt", "annual normals", resolution="800m") %>% pd_to_file() %>% rast()
tmin1.normal <- prism_archive_subset("tmin", "monthly normals", mon=1, resolution="800m") %>% pd_to_file() %>% rast()
tmax7.normal <- prism_archive_subset("tmax", "monthly normals", mon=7, resolution="800m") %>% pd_to_file() %>% rast()

# weather 2020
ppt.2020 <- prism_archive_subset("ppt", "annual", year=2020) %>% pd_to_file() %>% rast()
ppt.2020.JJASO <- prism_archive_subset("ppt", "monthly", year=2020, mon=6:10) %>% pd_to_file() %>% rast()
tmax.2020.JJASO <- prism_archive_subset("tmax", "monthly", year=2020, mon=6:10) %>% pd_to_file() %>% rast()

# precip 2021
ppt.2021 <- prism_archive_subset("ppt", "annual", year=2021) %>% pd_to_file() %>% rast()

# precip 2022
ppt.2022 <- prism_archive_subset("ppt", "annual",year=2022) %>% pd_to_file() %>% rast()

# Sample and characterize patterns
## Cameron Peak
CameronPeak.sample.pts <- spatSample(CameronPeak.severity, 10000, method="random", replace=FALSE, na.rm=T, as.points=TRUE, values=TRUE, cells=FALSE) 
CameronPeak.sample.pts <- extract(aspen, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(aspen.prefire.distance, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(aspen.live.distance, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(dem, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(ppt.normal, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(tmin1.normal, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(tmax7.normal, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(ppt.2021, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(ppt.2022, CameronPeak.sample.pts, bind=T)

CameronPeak.sample.df <- CameronPeak.sample.pts %>% as.data.frame()
colnames(CameronPeak.sample.df) <- c("severity", "aspen", "distance.pre", "distance.post", "elevation", "ppt", "tmin", "tmax", "ppt.2021", "ppt.2022")
write.csv(CameronPeak.sample.df, here("Results", "CameronPeak-attributes.csv"))

## Study sites
sites <- read_excel(here("Data", "Postfire-Regen-Clean.xlsx"), sheet="Site") %>% dplyr::select("Site", "Easting", "Northing")
sites.sf <- sites %>%  st_as_sf(coords = c("Easting", "Northing"), crs = "EPSG:32613") 
sites.sf <- extract(severity, sites.sf, bind=T)
sites.sf <- extract(aspen, sites.sf, bind=T)
sites.sf <- extract(aspen.prefire.distance, sites.sf, bind=T)
sites.sf <- extract(aspen.live.distance, sites.sf, bind=T)
sites.sf <- extract(dem, sites.sf, bind=T)
sites.sf <- extract(ppt.normal, sites.sf, bind=T)
sites.sf <- extract(tmin1.normal, sites.sf, bind=T)
sites.sf <- extract(tmax7.normal, sites.sf, bind=T)
sites.sf<- extract(ppt.2021, sites.sf, bind=T)
sites.sf <- extract(ppt.2022, sites.sf, bind=T)
sites.df<- sites.sf %>% as.data.frame()
colnames(sites.df) <- c("Site", "severity", "aspen", "distance.pre", "distance.post", "elevation", "ppt", "tmin", "tmax", "ppt.2021", "ppt.2022")
write.csv(sites.df, here("Results", "sites-attributes.csv"))



p1 <- CameronPeak.sample.df %>% ggplot(aes(x=elevation, y=distance.pre))+geom_hex()+ylim(0,2100)+
  scale_fill_viridis_c(begin = 0, end = .9, option = "C", limit = range(c(0,250)))+ylab("distance to live\naspen pre-fire (m)")
p2 <- CameronPeak.sample.df %>%  ggplot(aes(x=elevation, y=distance.post))+geom_hex()+ylim(0,2100)+
  scale_fill_viridis_c(begin = 0, end = .9, option = "C", limit = range(c(0,250)))+ylab("distance to live\naspen post-fire (m)")
p3 <- CameronPeak.sample.df  %>% mutate(aspen=factor(aspen, level=c(0,1), labels=c("absent", "present"))) %>% ggplot(aes(y=elevation, x=aspen))+geom_boxplot()+xlab("aspen occurrence")+ylab("elevation (m)")
p4 <- CameronPeak.sample.df %>% mutate(severity=factor(severity, level=c(1, 2, 3, 4), labels=c("unburned", "low", "moderate", "high"))) %>% ggplot(aes(y=elevation, x=factor(severity)))+geom_boxplot()+xlab("fire severity")+ylab("elevation (m)")
p1234 <- p1 + p2 + p3+ p4+plot_layout(nrow=2, guides="collect") + plot_annotation(tag_levels = "A") &
  theme(legend.position='bottom')

ggsave(here("Results", "Figures", "CameronPeak-patterns.jpg"), width=5, height=4, units="in", p1234)
```

# References
