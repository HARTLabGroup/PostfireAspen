---
title: "Spatial data for: Limited conifer regeneration, but widespread regeneration of aspen seedlings following the Cameron Peak Fire, northwestern Colorado"
author: "Sarah V. Carter and Sarah J. Hart"
email: "sarah.hart@colostate.edu"
output: 
   officedown::rdocx_document:
     reference_docx: Template.docx
bibliography: references.bib
csl: "`r here::here('citationstyle.csl')`"
link-citations: true
urlcolor: blue
linkcolor: blue
citationcolor: blue
---

```{r setup,include=FALSE, results='hide'}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	progress = FALSE,
	cache = FALSE,
	dpi = 300,
  fig.align = 'center'
)

set.seed(513)
options(repos = c(CRAN = "http://cran.rstudio.com"))
options(timeout=60*60) # timeout downloads that last longer than an hour

### Import libraries
if (!require("remotes"))  install.packages("remotes")
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, # easy file structure
  rmarkdown, # 
  flextable, # tables
  officer, # word documents
  bookdown, # word documents
  tidyverse, # data manipulation
  magrittr, # pipe functions 
  ggplot2, # figures
  RColorBrewer, # color palettes
  patchwork, # combining figures
  sf, # spatial data
  terra, # raster data
  tidyterra, # raster data
  stars, # raster data
  tmap, # easy plotting of maps
  terrainr, # dem
  DescTools, # degrees to radian
  prism, # prism data
  tmaptools, # helper library for tmap
  grid, # useful for plotting inset map
  prism, # prism data
  readxl, # read excel files
  googledrive
) 

proj.proj <- 4629

# Set custom plotting theme
theme_new <- function(base_size = 9,base_family = "Helvetica"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.line.x = element_line(color="black", linewidth = 0.25),
      axis.line.y = element_line(color="black", linewidth = 0.25),
      axis.title = element_text(size = 9),
      axis.text = element_text(colour="black", size=8),
      legend.key=element_rect(colour=NA, fill =NA),
      panel.grid = element_blank(),   
      plot.background = element_rect(fill = NA, colour = NA),
      panel.border = element_rect(fill = NA, colour = NA),
      panel.background = element_rect(fill = "white", colour = "black"), 
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 9)
      
    )
}
theme_set(theme_new())

set_flextable_defaults(
  font.family="Times", 
  font.size=12,
  line_spacing=1,
  padding.bottom=1,
  padding.top=1,
  text.align='center')

# Set directory structure for project
dir.create(here("Data", "Spatial"), showWarnings = FALSE)
dir.create(here("Results"), showWarnings = FALSE)
dir.create(here("Results", "Figures"), showWarnings = FALSE)
```

# Overview

The following code will download nearly all publicly-available spatial data used in this study. Where data is not publicly-available or easy to programmatically download, we provide more details about how to access the data.

# Spatial data

## Basic Geographic data

We obtained spatial data describing state boundaries from the US Census Bureau (<https://www.census.gov/geographies/mapping-files.html>).

```{r States, echo=T}
# states
dir.create(here("Data", "Spatial", "States"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "States", "cb_2018_us_state_20m.zip")
if(!file.exists(temp)){
  download.file("https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_us_state_20m.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "States"))
  
  st_read(here("Data", "Spatial", "States", "cb_2018_us_state_20m.shp")) %>% 
    filter(STUSPS %in% c("WA", "OR", "CA", "ID", "NV", "AZ", "MT", "UT", "NM", "CO", "WY")) %>% 
    st_write(here("Data", "Spatial", "States", "cb_2018_us_state_20m-WUS.shp"))
}

```

We also obtained spatially data describing land ownership from the Colorado Natural Heritage Program [-@coloradonaturalheritageprogram2019ColoradoOwnershipManagement].

```{r LandOwnership}
dir.create(here("Data", "Spatial", "CoMaP"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "CoMaP", "COMaP_v20190306.gdb.zip")
if(!file.exists(temp)){
  drive_download(
  file="https://drive.google.com/file/d/1lJVJlDVQmXX9n67mG1a4lTys9D8WPmBg/view?usp=sharing",
  path = temp,
  overwrite = TRUE
  )
  unzip(temp, exdir=here("Data", "Spatial", "CoMaP"))
}
```

To identify sites that were easily accessible, we acquired spatial data describing the location of roads from CDOT and the USFS and the location of trails from the USFS.

```{r CDOTroads}
if(!dir.exists(here("Data", "Spatial", "Roads"))){
  dir.create(here("Data", "Spatial", "Roads"), showWarnings = FALSE)
  temp <- here("Data", "Spatial", "Roads", "CO_HWY.zip")
  download.file("http://dtdapps.coloradodot.info/staticdata/Downloads/StateGeoData/highways.zip", temp )
  unzip(temp, exdir=here("Data", "Spatial", "Roads"))

  temp <- here("Data", "Spatial", "Roads", "CO_LocalRoads.zip")
  download.file("http://dtdapps.coloradodot.info/staticdata/Downloads/StateGeoData/LocalRoads.zip", temp )
  unzip(temp, exdir=here("Data", "Spatial", "Roads"))

  temp <- here("Data", "Spatial", "Roads", "CO_MajorRoads.zip")
  download.file("http://dtdapps.coloradodot.info/staticdata/Downloads/StateGeoData/MajorRoads.zip", temp )
  unzip(temp, exdir=here("Data", "Spatial", "Roads"))
}
```

```{r USFSroads}
temp <- here("Data", "Spatial", "Roads", "S_USA.Road_MVUM.zip")
if(!file.exists(temp)){
  download.file("https://data.fs.usda.gov/geodata/edw/edw_resources/shp/S_USA.Road_MVUM.zip", temp )
  unzip(temp, exdir=here("Data", "Spatial", "Roads"))
}
```

```{r USFStrails}
if(!dir.exists(here("Data", "Spatial", "Trails"))){
  dir.create(here("Data", "Spatial", "Trails"), showWarnings = FALSE)
  temp <- here("Data", "Spatial", "Trails", "S_USA.TrailNFS_Publish.zip")
  download.file("https://data.fs.usda.gov/geodata/edw/edw_resources/fc/S_USA.TrailNFS_Publish.gdb.zip", temp)
  unzip(temp, exdir=here("Data", "Spatial", "Trails"))
}
```

## Topographic data

We obtained a 250 m resolution Digital Elevation Model (DEM) for the study area from the National Elevation Dataset (NED) using the *terrainr* package [@terrainr].

```{r DEM}
dir.create(here("Data", "Spatial", "DEM"), showWarnings = FALSE)
if(!file.exists(here("Data", "Spatial", "DEM", "DEM30.tif"))){
 # Read in perimeter data
CameronPeak <- st_read(here("Data", "Spatial", "MTBS", "mtbs_perims_DD.shp")) %>% 
  filter(Incid_Name == "CAMERON PEAK")  %>% st_transform(crs=5071) %>% st_buffer(20000)
  dir.create(here("Data", "Spatial","DEM"), showWarnings = FALSE)

 # 30 m 
  dem <- get_tiles(data=CameronPeak, output_prefix = here("Data", "Spatial", "DEM", "DEM30"), services="elevation",   resolution=30)
  dem.rast <- rast(dem$elevation)
  writeRaster(dem.rast, here("Data", "Spatial", "DEM", "DEM30.tif"), overwrite=T)
}

if(!file.exists(here("Data", "Spatial", "DEM", "DEM250.tif"))){
  # Read in ecoregion data
  SRM <- st_read(here("Data", "Spatial", "Ecoregions", "US_Eco_L3.shp")) %>% filter(US_L3NAME=="Southern Rockies")
  
  # 250 m
  dem <- get_tiles(data=SRM, output_prefix = here("Data", "Spatial", "DEM", "DEM250"), services="elevation",   resolution=250)
  dem.rast <- lapply(dem$elevation,FUN=rast)
  writeRaster(dem.rast[[1]], here("Data", "Spatial", "DEM", "DEM250.tif"), overwrite=T)
  }
```

## Weather and climate data

To characterize the study area's climate, we obtained 30-year normals (1991-2020) of monthly precipitation totals, minimum temperatures, and maximum temperature from PRISM [@prismclimategroup2021Monthly30yearClimate]. To characterize post-fire weather conditions, which are an important driver of aspen seedling establishment, we also obtained monthly precipitation and maximum temperature for 2021 and 2022 from PRISM [@prismclimategroup2021MonthlyTimeSeries]. Both datasets were retrieved using the *prism* package [@prism].

```{r PRISM}
if(!dir.exists(here("Data", "Spatial", "PRISM"))){
  dir.create(here("Data", "Spatial", "PRISM"), showWarnings = FALSE)
  prism_set_dl_dir(here("Data", "Spatial", "PRISM"))
  
  # Climate normals
  get_prism_normals("ppt", "800m", annual = TRUE, keepZip = FALSE)
  get_prism_normals("tmean", "800m", annual = TRUE, keepZip = FALSE)

  get_prism_normals("ppt", "4km", mon=1:12, keepZip = FALSE)
  get_prism_normals("tmin", "4km", mon=1:12, keepZip = FALSE)
  get_prism_normals("tmax", "4km", mon=1:12, keepZip = FALSE)
  
  # Weather 2020, 2021 and 2022
  get_prism_annual("ppt", years=2020:2022, keepZip = FALSE)
  get_prism_monthlys("ppt", years=2020:2022, mon=1:12, keepZip = FALSE)
  get_prism_monthlys("tmax", years=2020:2022, mon=1:12, keepZip = FALSE)
}
```

## Vegetation

To characterize the occurrence of aspen across the study area prior to the fire, we obtained a 10-m gridded map of aspen presence-absence produced by Cook et al. [-@cook2024MappingQuakingAspen]. Briefly, this dataset was produced in Google Earth Engine using 10-m seasonal composite imagery from the Sentinel-1 and Sentinel-2 sensors. The map represents the distribution of aspen in ca. 2019 and is characterized by high accuracy (0.93 average F1-score).

```{r DL_aspen}
# Download Aspen data from Cook et al. 2024
dir.create(here("Data", "Spatial", "Aspen"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "Aspen", "srme_skcv_distribution_binopt.tif", mode="wb")
if(!file.exists(temp)){
  download.file("https://1drv.ms/u/s!Aq4s9rj0qHBilL4B4PH1amvdUoiLyg?e=jHRUWI", temp )
}
```

## Disturbance data

We acquired polygon data describing the extent and severity of the Cameron Peak fire from the Monitoring Trends in Burn Severity Project [@mtbsproject2024MTBSDataAccess; @mtbsproject2024MTBSDataAccessa] ([mtbs.gov](mtbs.gov)).

```{r MTBS}
# MTBS fire perimeter
dir.create(here("Data", "Spatial", "MTBS"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "MTBS", "mtbs_perimeter_data.zip")
if(!file.exists(temp)){
  download.file("https://edcintl.cr.usgs.gov/downloads/sciweb1/shared/MTBS_Fire/data/composite_data/burned_area_extent_shapefile/mtbs_perimeter_data.zip", temp)
  unzip(temp, exdir=here("Data", "Spatial", "MTBS"))
}

# MTBS burn severity
dir.create(here("Data", "Spatial", "MTBS"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "MTBS", "mtbs_CO_2020.zip")
if(!file.exists(temp)){
  drive_download(
  file="https://drive.google.com/file/d/1uj9QeBrZjSdhlf4ILtTglvWXlK2tfTha/view?usp=sharing",
  path = temp,
  overwrite = TRUE
  )
  unzip(temp, exdir=here("Data", "Spatial", "MTBS"))
}
```

We also obtained 30 m maps of the severity (i.e., cumulative percent basal area mortality) of recent (1997–2019) bark beetle-caused tree mortality from Rodman et al. [-@rodman2021DataEffectsBark]. Briefly this dataset was produced using Landsat time series data in combination with an extensive field data [@rodman2021EffectsBarkBeetle]. This dataset can be downloaded from Dryad at https://datadryad.org/dataset/doi:10.5061/dryad.1rn8pk0sn.  In our analyses, we downloaded the full dataset and unzipped it within the project subdirectory `~Data/Spatial`.


## Preprocessing of geospatial data

To characterize the distribution of live and fire-killed mature aspen, we overlaid the MTBS map of fire severity [@mtbsproject2024MTBSDataAccess] on Cook et al.'s [@cook2024MappingQuakingAspen] map of pre-fire aspen occurrence. We assumed that any aspen stem that burned at moderate or high severity was likely killed in the fire.
```{r LiveDeadAspen}
dir.create(here("Data", "Spatial", "Processed"))
if(!file.exists(here("Data", "Spatial", "Aspen", "Aspen-dead-highmod.tif"))){
  
  # Read in aspen presence/absence data
  aspen <- rast(here("Data", "Spatial", "Aspen", "srme_skcv_distribution_binopt.tif"))

  # Read in fire severity data
  severity <-  rast(here('Data', 'Spatial', 'MTBS', 'mtbs_CO_2020.tif'))

  # Read in perimeter data
  CameronPeak <- st_read(here("Data", "Spatial", "MTBS", "mtbs_perims_DD.shp")) %>% 
  filter(Incid_Name == "CAMERON PEAK") %>% # pull out just Cameron Peak
  st_transform(st_crs(severity)) # transform 

  CameronPeak %>% st_write(here("Data", "Spatial", "MTBS", "mtbs_perims_DD-CameronPeak.shp"), append=F)

  # Buffer fire by 5 km
  CameronPeak.buffer5000 <- CameronPeak %>% 
    st_buffer(dist=5000)
  
  # Clip severity raster 
  CameronPeak.severity <- crop(severity, st_bbox(CameronPeak.buffer5000))
  
  # Convert to polygon
  CameronPeak.highmodseverity.p <- CameronPeak.severity %>% 
    st_as_stars() %>% 
    st_as_sf(as_points = FALSE, merge =TRUE) %>%
    filter(mtbs_CO_2020 %in% 3:4) %>% # select only moderate and high severity pixels
    st_union() # union
  st_write(CameronPeak.highmodseverity.p, dsn=here("Data", "Spatial", "Processed", "CameronPeak-highmod.shp"), append=F) # write to file
  
  # Convert aspen data from raster to polygon
  aspen <- aspen %>% crop(st_bbox(st_transform(CameronPeak.buffer5000, st_crs(aspen)))) # crop aspen data to area in and surrounding Cameron Peak
  
  aspen.p <- aspen %>% 
    st_as_stars() %>% 
    st_as_sf(as_points = FALSE, merge =TRUE) %>%
    filter(Band_1==1) %>% 
    st_union(append=F) # union
  st_write(aspen.p, dsn=here("Data", "Spatial", "Processed", "Aspen-CameronPeak.shp"),append=F)
  aspen.r <- rasterize(st_as_sf(aspen.p), aspen, filename=here("Data", "Spatial", "Processed", "Aspen-total.tif"), overwrite=T)
  
  # Get area of live aspen --> exclude aspen that burned at moderate or high severity
  CameronPeak.highmodseverity.p <- CameronPeak.highmodseverity.p  %>% st_transform(st_crs(aspen.p))
  aspen.live.highmod <- st_difference(aspen.p, CameronPeak.highmodseverity.p)
  st_write(aspen.live.highmod, here("Data", "Spatial", "Processed", "aspen-live-highmod.shp"), append=F) # write to file
  aspen.live.highmod.r <- rasterize(st_as_sf(aspen.live.highmod), aspen, filename=here("Data", "Spatial", "Aspen", "Aspen-live  -highmod.tif"), overwrite=T)
  
  # Get area of dead aspen --> only aspen that burned at moderate or high severity
  CameronPeak.highmodseverity.p <- CameronPeak.highmodseverity.p  %>% st_transform(st_crs(aspen.p))
  aspen.dead.highmod <- st_intersection(aspen.p, CameronPeak.highmodseverity.p)
  st_write(aspen.dead.highmod, here("Data", "Spatial", "Processed", "aspen-dead-highmod.shp"), append=F) # write to file
  aspen.dead.highmod.r <- rasterize(st_as_sf(aspen.dead.highmod), aspen, filename=here("Data", "Spatial", "Aspen", "Aspen-dead-highmod.tif"), overwrite=T)
}
```

We then calculated the distance from plot center to the nearest live aspen pixel in R [@rcoreteam2024LanguageEnvironmentStatistical] using the terra package [@hijmans2022TerraSpatialData].
```{r dist2aspen}
  # Calculate distance to aspen
  aspen.distance <- distance(aspen.r, filename=here("Data", "Spatial", "Processed", "aspen-dist.tif"), overwrite=T)
  aspen.live.highmod.distance <- distance(aspen.live.highmod.r, filename=here("Data", "Spatial","Processed", "aspen-live-highmod-dist.tif"), overwrite=T)
```

We then calculated the distance from plot center to the nearest live aspen pixel in R [@rcoreteam2024LanguageEnvironmentStatistical] using the terra package [@hijmans2022TerraSpatialData].
```{r dist2lowseverity}
if(!file.exists(here("Data", "Spatial", "Processed", "CameronPeak.severitylow-dist.tif"))){
  # Read in fire severity data
  severity <-  rast(here('Data', 'Spatial', 'MTBS', 'mtbs_CO_2020.tif'))

  # Read in perimeter data
  CameronPeak <- st_read(here("Data", "Spatial", "MTBS", "mtbs_perims_DD.shp")) %>% 
    filter(Incid_Name == "CAMERON PEAK") %>% # pull out just Cameron Peak
    st_transform(st_crs(severity)) # transform 
  
  CameronPeak %>% st_write(here("Data", "Spatial", "MTBS", "mtbs_perims_DD-CameronPeak.shp"), append=F)
  
  # Buffer fire by 5 km
  CameronPeak.buffer5000 <- CameronPeak %>% 
    st_buffer(dist=5000)
  
  # Clip severity raster 
  CameronPeak.severity <- crop(severity, st_bbox(CameronPeak.buffer5000))
  
  ## Calculate distance to area burned at low severity or unburned
  CameronPeak.severitylow <- CameronPeak.severity
  CameronPeak.severitylow[is.na(CameronPeak.severitylow)] <-1
  CameronPeak.severitylow[CameronPeak.severitylow>2]<-NA
  CameronPeak.severitylow[CameronPeak.severitylow==2]<-1
  CameronPeak.severitylow.distance <- distance(CameronPeak.severitylow, filename=here("Data", "Spatial", "Processed", "CameronPeak.severitylow-dist.tif"), overwrite=T)
}
```

# References
