---
title: "Spatial data for: "
author: "Sarah V. Carter and Sarah J. Hart"
email: "sarah.hart@colostate.edu"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output: 
   officedown::rdocx_document:
     reference_docx: Template.docx
bibliography: references.bib
csl: "`r here::here('citationstyle.csl')`"
link-citations: true
urlcolor: blue
linkcolor: blue
citationcolor: blue
---846
---

```{r setup,include=FALSE, results='hide'}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	progress = FALSE,
	cache = FALSE,
	dpi = 300,
  fig.align = 'center'
)

set.seed(513)
options(repos = c(CRAN = "http://cran.rstudio.com"))
options(timeout=60*60) # timeout downloads that last longer than an hour

### Import libraries
if (!require("remotes"))  install.packages("remotes")
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, # easy file structure
  rmarkdown, # 
  flextable, # tables
  officer, # word documents
  bookdown, # word documents
  tidyverse, # data manipulation
  magrittr, # pipe functions 
  ggplot2, # figures
  RColorBrewer, # color palettes
  patchwork, # combining figures
  sf, # spatial data
  terra, # raster data
  tidyterra, # raster data
  stars, # raster data
  tmap, # easy plotting of maps
  terrainr, # dem
  DescTools, # degrees to radian
  prism, # prism data
  tmaptools, # helper library for tmap
  grid, # useful for plotting inset map
  prism, # prism data
  readxl, # read excel files
  googledrive
) 

proj.proj <- 4629

# Set custom plotting theme
theme_new <- function(base_size = 9,base_family = "Helvetica"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.line.x = element_line(color="black", linewidth = 0.25),
      axis.line.y = element_line(color="black", linewidth = 0.25),
      axis.title = element_text(size = 9),
      axis.text = element_text(colour="black", size=8),
      legend.key=element_rect(colour=NA, fill =NA),
      panel.grid = element_blank(),   
      plot.background = element_rect(fill = NA, colour = NA),
      panel.border = element_rect(fill = NA, colour = NA),
      panel.background = element_rect(fill = "white", colour = "black"), 
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 9)
      
    )
}
theme_set(theme_new())

set_flextable_defaults(
  font.family="Times", 
  font.size=12,
  line_spacing=1,
  padding.bottom=1,
  padding.top=1,
  text.align='center')

# Set directory structure for project
dir.create(here("Data", "Spatial"), showWarnings = FALSE)
dir.create(here("Results"), showWarnings = FALSE)
dir.create(here("Results", "Figures"), showWarnings = FALSE)
```

# Overview

The following code will download nearly all publicly-available spatial data used in this study. Where data is not publicly-available or easy to programmatically download, we provide more details about how to access the data.

# Spatial data

## Basic Geographic data

We obtained spatial data describing state boundaries from the US Census Bureau (<https://www.census.gov/geographies/mapping-files.html>).

```{r States, echo=T}
# states
dir.create(here("Data", "Spatial", "States"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "States", "cb_2018_us_state_20m.zip")
if(!file.exists(temp)){
  download.file("https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_us_state_20m.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "States"))
  
  st_read(here("Data", "Spatial", "States", "cb_2018_us_state_20m.shp")) %>% 
    filter(STUSPS %in% c("WA", "OR", "CA", "ID", "NV", "AZ", "MT", "UT", "NM", "CO", "WY")) %>% 
    st_write(here("Data", "Spatial", "States", "cb_2018_us_state_20m-WUS.shp"))
}

```

We obtained Level III Ecoregion data for the United States from the US Environmental Protection Agency (<https://www.epa.gov/eco-research/ecoregions-north-america>).

```{r Ecoregion}
# ecoregion
dir.create(here("Data", "Spatial", "Ecoregions"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "Ecoregions","us_eco_l3.zip")
if(!file.exists(temp)){
  download.file("https://dmap-prod-oms-edc.s3.us-east-1.amazonaws.com/ORD/Ecoregions/us/us_eco_l3.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Ecoregions"))
}
```

We also obtained spatially data describing land ownership from the Colorado Natural Heritage Program [-@coloradonaturalheritageprogram2019ColoradoOwnershipManagement].

```{r LandOwnership}
dir.create(here("Data", "Spatial", "CoMaP"), showWarnings = FALSE)
temp <- here(paste0("Data", "Spatial", "CoMaP", "COMaP_v20190306.gdb.zip"))
if(!file.exists(temp)){
  drive_download(
  file="https://drive.google.com/file/d/1lJVJlDVQmXX9n67mG1a4lTys9D8WPmBg/view?usp=sharing",
  path = temp,
  overwrite = TRUE
  )
  unzip(temp, exdir=here("Data", "Spatial", "CoMaP"))
}
```

## Disturbance data

We acquired polygon data describing the extent and severity of the Cameron Peak fire from the Monitoring Trends in Burn Severity Project [@mtbsproject2024MTBSDataAccess; @mtbsproject2024MTBSDataAccessa] ([mtbs.gov](mtbs.gov)).

```{r MTBS, echo=T}
dir.create(here("Data", "Spatial", "MTBS"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "MTBS", "mtbs_perimeter_data.zip")
if(!file.exists(temp)){
  download.file("https://edcintl.cr.usgs.gov/downloads/sciweb1/shared/MTBS_Fire/data/composite_data/burned_area_extent_shapefile/mtbs_perimeter_data.zip", temp)
  unzip(temp, exdir=here("Data", "Spatial", "MTBS"))
}


# MTBS burn severity
dir.create(here("Data", "Spatial", "MTBS"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "MTBS", "mtbs_CO_2020.zip")
if(!file.exists(temp)){
  drive_download(
  file="https://drive.google.com/file/d/1uj9QeBrZjSdhlf4ILtTglvWXlK2tfTha/view?usp=sharing",
  path = temp,
  overwrite = TRUE
  )
  unzip(temp, exdir=here("Data", "Spatial", "MTBS"))
}
```

We also obtained 30 m maps of the severity (i.e., cumulative percent basal area mortality) of recent (1997â€“2019) bark beetle-caused tree mortality from Rodman et al. [-@rodman2021DataEffectsBark]. Briefly this dataset was produced using Landsat time series data in combination with an extensive field data [@rodman2021EffectsBarkBeetle]. This dataset can be downloaded from Dryad at https://datadryad.org/dataset/doi:10.5061/dryad.1rn8pk0sn.  In our analyses, we downloaded the full dataset and unzipped it within the project subdirectory `~Data/Spatial`.

## Topographic data
We obtained a 250 m resolution Digital Elevation Model (DEM) for the study area from the National Elevation Dataset (NED) using the *terrainr* package [@terrainr].

```{r DEM}
dir.create(here("Data", "Spatial", "DEM"), showWarnings = FALSE)
if(!file.exists(here("Data", "Spatial", "DEM", "DEM30.tif"))){
 # Read in perimeter data
CameronPeak <- st_read(here("Data", "Spatial", "MTBS", "mtbs_perims_DD.shp")) %>% 
  filter(Incid_Name == "CAMERON PEAK")  %>% st_transform(crs=5071) %>% st_buffer(20000)
  dir.create(here("Data", "Spatial","DEM"), showWarnings = FALSE)

 # 30 m 
  dem <- get_tiles(data=CameronPeak, output_prefix = here("Data", "Spatial", "DEM", "DEM30"), services="elevation",   resolution=30)
  dem.rast <- rast(dem$elevation)
  writeRaster(dem.rast, here("Data", "Spatial", "DEM", "DEM30.tif"), overwrite=T)
}

if(!file.exists(here("Data", "Spatial", "DEM", "DEM250.tif"))){
  # Read in ecoregion data
  SRM <- st_read(here("Data", "Spatial", "Ecoregions", "US_Eco_L3.shp")) %>% filter(US_L3NAME=="Southern Rockies")
  
  # 250 m
  dem <- get_tiles(data=SRM, output_prefix = here("Data", "Spatial", "DEM", "DEM250"), services="elevation",   resolution=250)
  dem.rast <- lapply(dem$elevation,FUN=rast)
  writeRaster(dem.rast[[1]], here("Data", "Spatial", "DEM", "DEM250.tif"), overwrite=T)
  }
```

## PRISM
To characterize the study area's climate, we obtained 30-year normals (1991-2020) of monthly precipitation totals, minimum temperatures, and maximum temperature from PRISM [@prismclimategroup2021Monthly30yearClimate]. To characterize post-fire weather conditions, which are an important driver of aspen seedling establishment, we also obtained annual precipitation totals for 2021 and 2022 from PRISM [@prismclimategroup2021MonthlyTimeSeries]. Both datasets were retrieved using the *prism* package [@prism].

```{r PRISM}
if(!dir.exists(here("Data", "Spatial", "PRISM"))){
  dir.create(here("Data", "Spatial", "PRISM"), showWarnings = FALSE)
  prism_set_dl_dir(here("Data", "Spatial", "PRISM"))
  
  # Climate normals
  get_prism_normals("ppt", "800m", annual = TRUE, keepZip = FALSE)
  get_prism_normals("tmean", "800m", annual = TRUE, keepZip = FALSE)

  get_prism_normals("ppt", "4km", mon=1:12, keepZip = FALSE)
  get_prism_normals("tmin", "4km", mon=1:12, keepZip = FALSE)
  get_prism_normals("tmax", "4km", mon=1:12, keepZip = FALSE)
  
  # Weather 2020, 2021 and 2022
  get_prism_annual("ppt", years=2020:2022, keepZip = FALSE)
  get_prism_monthlys("ppt", years=2020:2022, mon=1:12, keepZip = FALSE)
  get_prism_monthlys("tmax", years=2020:2022, mon=1:12, keepZip = FALSE)
}
```

```{r Distance2Aspen}
dir.create(here("Data", "Spatial", "Processed"))
if(!file.exists(here("Data", "Spatial","Processed", "aspen-live-highmod-dist.tif"))){
  
  # Read in aspen presence/absence data
  aspen <- rast(here("Data", "Spatial", "Aspen", "srme_skcv_distribution_binopt.tif"))

  # Read in fire severity data
  severity <-  rast(here('Data', 'Spatial', 'MTBS', 'mtbs_CO_2020.tif'))

  # Read in perimeter data
  CameronPeak <- st_read(here("Data", "Spatial", "MTBS", "mtbs_perims_DD.shp")) %>% 
  filter(Incid_Name == "CAMERON PEAK") %>% # pull out just Cameron Peak
  st_transform(st_crs(severity)) # transform 

  CameronPeak %>% st_write(here("Data", "Spatial", "MTBS", "mtbs_perims_DD-CameronPeak.shp"), append=F)

  # Buffer fire by 5 km
  CameronPeak.buffer5000 <- CameronPeak %>% 
    st_buffer(dist=5000)
  
  # Clip severity raster 
  CameronPeak.severity <- crop(severity, st_bbox(CameronPeak.buffer5000))
  
  # Convert to polygon
  CameronPeak.highseverity.p <- CameronPeak.severity %>% 
    st_as_stars() %>% 
    st_as_sf(as_points = FALSE, merge =TRUE) %>%
    filter(mtbs_CO_2020 %in% 4) %>% # select only high severity pixels
    st_union() # union
  st_write(CameronPeak.highseverity.p, dsn=here("Data", "Spatial", "Processed", "CameronPeak-highseverity.shp"), append=F) # write to file
  
  CameronPeak.highmodseverity.p <- CameronPeak.severity %>% 
    st_as_stars() %>% 
    st_as_sf(as_points = FALSE, merge =TRUE) %>%
    filter(mtbs_CO_2020 %in% 3:4) %>% # select only moderate and high severity pixels
    st_union() # union
  st_write(CameronPeak.highmodseverity.p, dsn=here("Data", "Spatial", "Processed", "CameronPeak-highmod.shp"), append=F) # write to file
  
  # Convert aspen data from raster to polygon
  aspen <- aspen %>% crop(st_bbox(st_transform(CameronPeak.buffer5000, st_crs(aspen)))) # crop aspen data to area in and surrounding Cameron Peak
  
  aspen.p <- aspen %>% 
    st_as_stars() %>% 
    st_as_sf(as_points = FALSE, merge =TRUE) %>%
    filter(Band_1==1) %>% 
    st_union(append=F) # union
  st_write(aspen.p, dsn=here("Data", "Spatial", "Processed", "Aspen-CameronPeak.shp"),append=F)
  aspen.r <- rasterize(st_as_sf(aspen.p), aspen, filename=here("Data", "Spatial", "Processed", "Aspen-total.tif"), overwrite=T)
  
  # Get area of live aspen --> exclude aspen that burned at high severity
  CameronPeak.highseverity.p <- CameronPeak.highseverity.p %>% st_transform(st_crs(aspen.p))
  aspen.live.high <- st_difference(aspen.p, CameronPeak.highseverity.p)
  st_write(aspen.live.high, here("Data", "Spatial", "Processed", "aspen-live-high.shp"), append=F) # write to file
  aspen.live.high.r <- rasterize(st_as_sf(aspen.live.high), aspen, filename=here("Data", "Spatial", "Aspen", "Aspen-live-high.tif"), overwrite=T)
  
  # Get area of live aspen --> exclude aspen that burned at modeate or high severity
  CameronPeak.highmodseverity.p <- CameronPeak.highmodseverity.p  %>% st_transform(st_crs(aspen.p))
  aspen.live.highmod <- st_difference(aspen.p, CameronPeak.highmodseverity.p)
  st_write(aspen.live.highmod, here("Data", "Spatial", "Processed", "aspen-live-highmod.shp"), append=F) # write to file
  aspen.live.highmod.r <- rasterize(st_as_sf(aspen.live.highmod), aspen, filename=here("Data", "Spatial", "Aspen", "Aspen-live  -highmod.tif"), overwrite=T)
  
  # Get area of dead aspen --> only aspen that burned at modeate or high severity
  CameronPeak.highmodseverity.p <- CameronPeak.highmodseverity.p  %>% st_transform(st_crs(aspen.p))
  aspen.dead.highmod <- st_intersection(aspen.p, CameronPeak.highmodseverity.p)
  st_write(aspen.dead.highmod, here("Data", "Spatial", "Processed", "aspen-dead-highmod.shp"), append=F) # write to file
  aspen.dead.highmod.r <- rasterize(st_as_sf(aspen.dead.highmod), aspen, filename=here("Data", "Spatial", "Aspen", "Aspen-dead  -highmod.tif"), overwrite=T)
  
  # Calculate distance to aspen
  aspen.distance <- distance(aspen.r, filename=here("Data", "Spatial", "Processed", "aspen-dist.tif"), overwrite=T)
  aspen.live.high.distance <- distance(aspen.live.high.r, filename=here("Data", "Spatial","Processed", "aspen-live-high-dist.tif"),   overwrite=T)
  aspen.live.highmod.distance <- distance(aspen.live.highmod.r, filename=here("Data", "Spatial","Processed", "aspen-live-highmod-dist.tif"), overwrite=T)

}
  
```

```{r dist2lowseverity}
if(!file.exists(here("Data", "Spatial", "Processed", "CameronPeak.severitylow-dist.tif"))){
  # Read in fire severity data
  severity <-  rast(here('Data', 'Spatial', 'MTBS', 'mtbs_CO_2020.tif'))

  # Read in perimeter data
  CameronPeak <- st_read(here("Data", "Spatial", "MTBS", "mtbs_perims_DD.shp")) %>% 
    filter(Incid_Name == "CAMERON PEAK") %>% # pull out just Cameron Peak
    st_transform(st_crs(severity)) # transform 
  
  CameronPeak %>% st_write(here("Data", "Spatial", "MTBS", "mtbs_perims_DD-CameronPeak.shp"), append=F)
  
  # Buffer fire by 5 km
  CameronPeak.buffer5000 <- CameronPeak %>% 
    st_buffer(dist=5000)
  
  # Clip severity raster 
  CameronPeak.severity <- crop(severity, st_bbox(CameronPeak.buffer5000))
  
  ## Calculate distance to area burned at low severity or unburned

  CameronPeak.severitylow <- CameronPeak.severity
  CameronPeak.severitylow[is.na(CameronPeak.severitylow)] <-1
  CameronPeak.severitylow[CameronPeak.severitylow>2]<-NA
  CameronPeak.severitylow[CameronPeak.severitylow==2]<-1
  CameronPeak.severitylow.distance <- distance(CameronPeak.severitylow, filename=here("Data", "Spatial", "Processed", "CameronPeak.severitylow-dist.tif"), overwrite=T)
}
```

# Characterize study area
```{r}
# Read in climate data
prism_set_dl_dir(here("Data", "Spatial", "PRISM"))

#normals
ppt.normal <- prism_archive_subset("ppt", "annual normals", resolution="800m") %>% pd_to_file() %>% rast()
ppt.normal.678910 <- prism_archive_subset("ppt", "monthly normals",  resolution="4km", mon=6:10) %>% pd_to_file() %>% rast() %>% sum()
ppt.normal.111212345 <- prism_archive_subset("ppt", "monthly normals",  resolution="4km", mon=c(1,2,3,4,5,11,12)) %>% pd_to_file() %>% rast() %>% sum()
tmean.normal <- prism_archive_subset("tmean", "annual normals", resolution="800m") %>% pd_to_file() %>% rast()
tmin.normal.1 <- prism_archive_subset("tmax", "monthly normals",  resolution="4km", mon=1) %>% pd_to_file() %>% rast()
tmax.normal.7 <- prism_archive_subset("tmax", "monthly normals",  resolution="4km", mon=7) %>% pd_to_file() %>% rast()
tmax.normal.678910 <- prism_archive_subset("tmax", "monthly normals",  resolution="4km", mon=6:10) %>% pd_to_file() %>% rast() %>% mean()

# weather 2021
ppt.2021 <- prism_archive_subset("ppt", "annual", year=2021) %>% pd_to_file() %>% rast()
ppt.2021.678910 <- prism_archive_subset("ppt", "monthly", year=2021, mon=6:10) %>% pd_to_file() %>% rast() %>% sum()
ppt.2021.1112 <- prism_archive_subset("ppt", "monthly", year=2020,  mon=11:12) %>% pd_to_file() %>% rast() %>% sum()
ppt.2021.12345 <- prism_archive_subset("ppt", "monthly", year=2021,  mon=1:5) %>% pd_to_file() %>% rast() %>% sum()
ppt.2021.111212345 <- ppt.2021.1112 + ppt.2021.12345
tmax.2021.678910 <- prism_archive_subset("tmax", "monthly", year=2021, mon=6:10) %>% pd_to_file() %>% rast() %>% mean()

# weather 2022
ppt.2022 <- prism_archive_subset("ppt", "annual",year=2022) %>% pd_to_file() %>% rast()
ppt.2022.678910 <- prism_archive_subset("ppt", "monthly", year=2022, mon=6:10) %>% pd_to_file() %>% rast() %>% sum()
ppt.2022.1112 <- prism_archive_subset("ppt", "monthly", year=2021,  mon=11:12) %>% pd_to_file() %>% rast() %>% sum()
ppt.2022.12345 <- prism_archive_subset("ppt", "monthly", year=2022,  mon=1:5) %>% pd_to_file() %>% rast() %>% sum()
ppt.2022.111212345 <- ppt.2022.1112 + ppt.2022.12345
tmax.2022.678910 <- prism_archive_subset("tmax", "monthly", year=2022, mon=6:10) %>% pd_to_file() %>% rast() %>% mean()

# Read in fire severity data
severity <-  rast(here('Data', 'Spatial', 'MTBS', 'mtbs_CO_2020.tif')) 
CameronPeak <-  st_read(here("Data", "Spatial", "MTBS", "mtbs_perims_DD.shp"))  %>% 
  filter(Incid_Name == "CAMERON PEAK") %>% # pull out just Cameron Peak
  st_transform(st_crs(severity)) # transform 
CameronPeak.severity <- crop(severity, st_bbox(CameronPeak ))
CameronPeak.severity[CameronPeak.severity >=5] <-NA
  
# Read in aspen data
aspen <- rast(here("Data", "Spatial", "Aspen", "srme_skcv_distribution_binopt.tif"))
aspen.live <- rast(here("Data", "Spatial", "Aspen", "Aspen-live-highmod.tif"))
aspen.live.distance <- rast(here("Data", "Spatial","Processed", "aspen-live-highmod-dist.tif"))
aspen.prefire.distance <- rast(here("Data", "Spatial", "Processed", "aspen-dist.tif"))

# Read in distance to severely burned 
CameronPeak.severitylow.distance <- rast(here("Data", "Spatial", "Processed", "CameronPeak.severitylow-dist.tif"))

# Read in elevation data
dem <- rast(here("Data", "Spatial", "DEM", "DEM30.tif"))

# Read in bark beetle data
bb.presence <- rast(here("Data", "Spatial", "Dryad", "Rodman", "Rodman et al. RS_DataArchive", "Data", "SpatialData", "BBPresence_finalMasked.tif"))
bb.severity <- rast(here("Data", "Spatial", "Dryad", "Rodman", "Rodman et al. RS_DataArchive", "Data", "SpatialData", "BBSeverity_finalMasked.tif"))

# Sample and characterize patterns
## Cameron Peak 
CameronPeak.sample.pts <- spatSample(CameronPeak.severity, 10000, method="random", replace=FALSE, na.rm=T, as.points=TRUE, values=TRUE, cells=FALSE) 
CameronPeak.sample.pts <- extract(aspen, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(aspen.prefire.distance, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(aspen.live.distance, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(CameronPeak.severitylow.distance, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(dem, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(ppt.normal, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(ppt.normal.111212345, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(ppt.normal.678910, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(tmean.normal, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(tmin.normal.1, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(tmax.normal.7, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(tmax.normal.678910, CameronPeak.sample.pts, bind=T)

CameronPeak.sample.pts <- extract(ppt.2021, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(ppt.2021.111212345, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(ppt.2021.678910, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(tmax.2021.678910, CameronPeak.sample.pts, bind=T)

CameronPeak.sample.pts <- extract(ppt.2022, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(ppt.2022.111212345, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(ppt.2022.678910, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(tmax.2022.678910, CameronPeak.sample.pts, bind=T)

CameronPeak.sample.pts <- extract(bb.presence, CameronPeak.sample.pts, bind=T)
CameronPeak.sample.pts <- extract(bb.severity, CameronPeak.sample.pts, bind=T)
  
CameronPeak.sample.df <- CameronPeak.sample.pts %>% as.data.frame()
colnames(CameronPeak.sample.df) <- c("severity", "aspen", "distance.pre", "distance.post", "distance.high", "elevation", "ppt", "ppt.111212345", "ppt.678910", "tmean", "tmin1", "tmax7", "tmax.678910", "ppt.2021", "ppt.111212345.2021", "ppt.678910.2021", "tmax.678910.2021", "ppt.2022", "ppt.111212345.2022", "ppt.678910.2022", "tmax.678910.2022",  "bb.presence", "bb.severity")
write.csv(CameronPeak.sample.df, here("Results", "CameronPeak-attributes.csv"))

## Study sites
sites <- read_excel(here("Data", "Postfire-Regen-Clean.xlsx"), sheet="Site") %>% dplyr::select("Site", "Easting", "Northing", "Aspect", "Slope")
sites.sf <- sites %>%  st_as_sf(coords = c("Easting", "Northing"), crs = "EPSG:32613") 
sites.sf <- extract(CameronPeak.severity, sites.sf, bind=T)
sites.sf <- extract(aspen, sites.sf, bind=T)
sites.sf <- extract(aspen.prefire.distance, sites.sf, bind=T)
sites.sf <- extract(aspen.live.distance, sites.sf, bind=T)
sites.sf <- extract(CameronPeak.severitylow.distance, sites.sf, bind=T)
sites.sf <- extract(dem, sites.sf, bind=T)
sites.sf <- extract(ppt.normal, sites.sf, bind=T)
sites.sf <- extract(ppt.normal.111212345, sites.sf, bind=T)
sites.sf <- extract(ppt.normal.678910, sites.sf, bind=T)
sites.sf <- extract(tmean.normal, sites.sf, bind=T)
sites.sf <- extract(tmin.normal.1, sites.sf, bind=T)
sites.sf <- extract(tmax.normal.7, sites.sf, bind=T)
sites.sf <- extract(tmax.normal.678910, sites.sf, bind=T)

sites.sf <- extract(ppt.2021, sites.sf, bind=T)
sites.sf <- extract(ppt.2021.111212345, sites.sf, bind=T)
sites.sf <- extract(ppt.2021.678910, sites.sf, bind=T)
sites.sf <- extract(tmax.2021.678910, sites.sf, bind=T)

sites.sf <- extract(ppt.2022, sites.sf, bind=T)
sites.sf <- extract(ppt.2022.111212345, sites.sf, bind=T)
sites.sf <- extract(ppt.2022.678910, sites.sf, bind=T)
sites.sf <- extract(tmax.2022.678910, sites.sf, bind=T)

sites.sf <- extract(bb.presence, sites.sf, bind=T)
sites.sf <- extract(bb.severity, sites.sf, bind=T)
  
sites.df <- sites.sf %>% as.data.frame()
colnames(sites.df) <- c("Site", "Aspect", "Slope","severity", "aspen", "distance.pre", "distance.post", "distance.high", "elevation", "ppt", "ppt.111212345", "ppt.678910", "tmean", "tmin1", "tmax7", "tmax.678910", "ppt.2021", "ppt.111212345.2021", "ppt.678910.2021", "tmax.678910.2021", "ppt.2022", "ppt.111212345.2022", "ppt.678910.2022", "tmax.678910.2022",  "bb.presence", "bb.severity")

# Calc folded aspect
sites.df$Longitude <- sites %>%  st_as_sf(coords = c("Easting", "Northing"), crs = "EPSG:32613") %>% st_transform(crs="epsg:4326") %>% st_coordinates() %>% as.data.frame() %>% st_drop_geometry() %>% pull(X)
sites.df$Latitude <- sites  %>%  st_as_sf(coords = c("Easting", "Northing"), crs = "EPSG:32613") %>% st_transform(crs="epsg:4326") %>% st_coordinates() %>% as.data.frame() %>% st_drop_geometry()  %>% pull(Y)
sites.df$FoldedAspect <- abs( 180 - abs(sites.df$Aspect-225))
sites.df$PotentialDirRad <- -1.467+1.582*cos(DegToRad(sites.df$Latitude))*cos(DegToRad(sites.df$Slope))-1.5*cos(sites.df$FoldedAspect)* sin(DegToRad(sites.df$Slope))*sin(DegToRad(sites.df$Latitude))-0.262*sin(DegToRad(sites.df$Latitude))*sin(DegToRad(sites.df$Slope))+0.607* sin(sites.df$FoldedAspect)*sin(DegToRad(sites.df$Slope))
sites.df$HeatLoad <- exp(sites.df$PotentialDirRad )

write.csv(sites.df, here("Results", "sites-attributes.csv"), row.names=F)
```

# References
