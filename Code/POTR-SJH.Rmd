---
title: "Site selection for postfire aspen project"
author: "Sarah Carter and Sarah Hart"
email: "Sarah.Hart@colostate.edu"
date: "June 16, 2022"
output: 
  bookdown::html_document2:
    code_folding: hide
    toc: TRUE
    toc_depth: 4
    toc_float: TRUE
    collapsed: TRUE
    theme: spacelab
    fig_caption: TRUE
    number_sections: FALSE
citationcolor: blue
csl: "`r here:::here('ecology.csl')`"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, dpi = 600, progress = FALSE, cache = FALSE, fig.width=5,  fig.height=3.5, fig.align="center")

set.seed(513)
options(repos = c(CRAN = "http://cran.rstudio.com"))
options(timeout=60*60*2) #timeout downloads that last longer than an hour
options(na.action = "na.fail")  

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, # easy file structure
  tidyverse, # data manipulation
  tidymodels, 
  ggplot2, # figures
  patchwork, # multiple figures
  readxl, # read excel files
  ggpubr, # plotting
  ggridges # plotting
) 


# Set custom plotting theme
theme_new <- function(base_size = 9,base_family = "Helvetica"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.line.x = element_line(color="black", size = 0.25),
      axis.line.y = element_line(color="black", size = 0.25),
      axis.title = element_text(size = 9),
      axis.text = element_text(colour="black", size=8),
      legend.key=element_rect(colour=NA, fill =NA),
      panel.grid = element_blank(),   
      plot.background = element_rect(fill = NA, colour = NA),
      panel.border = element_rect(fill = NA, colour = NA),
      panel.background = element_rect(fill = "white", colour = "black"), 
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 9)
      
    )
}
theme_set(theme_new())

options(ggplot2.continuous.colour="viridis")
options(scipen=999)

# Set directory structure for project
dir.create(here("Data/"), showWarnings = FALSE)
dir.create(here("Results/"), showWarnings = FALSE)
```

# Import data
```{r importData}

POTR <- read_excel(here("Data", "POTR Seedling Data-2.xlsx"))
#str(POTR)
colnames(POTR) <- tolower(c("SITE.NAME", "SITE.NO", "TRANSECT", "SUBPLOT", "HEIGHT", "SUBSTRATE", "SM.TOPO", "LG.TOPO", "LG.CWD", "SM.CWD","SUCKER.DIST", "CC", "BROWSE"))

POTR_site <- read_excel(here("Data", "POTR SITE DATA.xlsx"))
#str(POTR_site)
colnames(POTR_site) <- tolower(c("SITE.NO", "CLUSTER", "UTM.E", "UTM.N", "ELEVATION", "SLOPE", "ASPECT", "TOPO", "TRANS.A.DIR", "TRANS.B.DIR", "LIVE.DIST", "DEAD.DIST"))

REGEN <- read_excel(here("Data", "ALL REGEN.xlsx"))
#str(REGEN)
colnames(REGEN) <- tolower(c("SITE.NO", "TRANSECT", "POINT", "ABLA", "PICO", "PIEN", "PIPO", "PSME", "POTR.sucker", "POTR.seed"))

#rename variables because they are confusing 
#POTR$site.name <- POTR$SITE.NAME
#POTR$site.Number <- POTR$SITE..
#POTR$height <- POTR$Height..cm.
```

# Data wrangling

```{r}
compiled <- merge(POTR, POTR_site, by = "site.no")

# 

compiled2 <- REGEN %>% group_by(site.no) %>% summarize_at(.vars=vars(abla:potr.seed), .fun=sum)
compiled2 <- merge(compiled2, 
POTR_site,  by = "site.no")
compiled2$potr.seed01 <- ifelse(compiled2$potr.seed>0, 1,0)

compiled.regen <- compiled.regen %>% group_by(site.no, transect)

#compiled
```

# Data exploration



## Seedling height by cluster
```{r}
#dotplot height by cluster
ggplot(compiled,aes(x=site.name,y=height, col = height)) + geom_point() + 
    xlab("Site Cluster Name") + 
    ylab(expression(paste("Height (cm)"))) +
    theme_bw(base_size = 16) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + ggtitle(" Seedling Height by Cluster")
```
```{r}
#boxplot height by cluster
ggplot(POTR, aes(x=site.name, y=height)) + 
  geom_boxplot() +
  xlab("Site Cluster") +
  ylab(expression(paste("Height (cm)"))) +
  ggtitle("Seedling Height by Cluster")

```
```{r}
#histogram counts
count <- count(compiled, site.name)
count

#filter for seedling density
dense <- compiled %>% filter(site.name == "CAM"| site.name == "LONG"| site.name == "MONTY"| site.name == "RAWAH" | site.name == "SNOW")

#height by cluster for dense clusters 
ggplot(dense,aes(x=site.name,y=height, col = height)) + geom_point() + 
    xlab("Site Cluster Name") + 
    ylab(expression(paste("Height cm"))) +
    theme_bw(base_size = 16) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + ggtitle(" Seedling Height by Cluster")

```
```{r}

ggline(dense, x = "site.name", y = "height", color = "site.name", add = c("mean_se", "jitter"),  ylab = "Height (cm)", xlab = "Cluster", labcol = "CLuster")

```
```{r}
tapply(compiled$height, compiled$site.name, summary)
```
```{r}
ggplot(POTR, aes(x = height, y = site.name, fill=site.name)) +
  geom_density_ridges() +
  xlab("Height cm") +
  ylab(expression(paste("Cluster Name"))) +
  ggtitle("Seedling Height Distribution")
```

#data filtering for tests
```{r}
library(dplyr)

#by cluster only
snow <- compiled %>% filter(SITE.NAME =="SNOW")
res <- compiled %>% filter(SITE.NAME =="RES")
rawah <- compiled %>% filter(SITE.NAME =="RAWAH")
monty <- compiled %>% filter(SITE.NAME =="MONTY")
long <- compiled %>% filter(SITE.NAME =="LONG")
lake <- compiled %>% filter(SITE.NAME =="LAKE")
fish <- compiled %>% filter(SITE.NAME =="FISH")
elkhorn <- compiled %>% filter(SITE.NAME =="ELKHORN")
cr69 <- compiled %>% filter(SITE.NAME =="CR69")
cam <- compiled %>% filter(SITE.NAME =="CAM")
blue <- compiled %>% filter(SITE.NAME =="BLUE")

#by substrate
ash <- compiled %>% filter(Substrate == "A"| Substrate == "A/B"| Substrate == "A/L"| Substrate == "A/M")
bryophyte <- compiled %>% filter(Substrate == "B"| Substrate == "B/A"| Substrate == "B/L"| Substrate == "B/M")
litter <- compiled %>% filter(Substrate == "L"| Substrate == "L/A"| Substrate == "L/B"| Substrate == "L/M")
mineral <- compiled %>% filter(Substrate == "M"| Substrate == "M/A"| Substrate == "M/B"| Substrate == "M/L")
rock <- compiled %>% filter(Substrate == "R")
wood <- compiled %>% filter(Substrate == "W")

#by small topo
cc <- compiled %>% filter(Small.Topo == "CC")
cv <- compiled %>% filter(Small.Topo == "CV")
f <- compiled %>% filter(Small.Topo == "F")
s <- compiled %>% filter(Small.Topo == "S")

#by large topo
CC <- compiled %>% filter(Large.Topo == "CC")
CV <- compiled %>% filter(Large.Topo == "CV")
F <- compiled %>% filter(Large.Topo == "F")
S <- compiled %>% filter(Large.Topo == "S")

#by elevation groups
high <- compiled %>% filter(Elevation > "3064")
moderate <- compiled %>% filter(between(Elevation, 2713,3064))
low <- compiled %>% filter(Elevation < "2713") 

#by large CWD
Lcwdp <- compiled %>% filter(Large.CWD == "1")
Lcwda <- compiled %>% filter(Large.CWD == "0")

#by small CWD
Scwdp <- compiled %>% filter(Small.CWD == "1")
Scwda <- compiled %>% filter(Small.CWD == "0")
```

#seedling count variable
```{r}
seedling_count_site <- count(compiled, compiled$SITE..)
seedling_count_cluster <- count(compiled, compiled$SITE.NAME)
```

#method of deciding relative site elevation groups
```{r}
#median(POTR_site$Elevation)
#min(POTR_site$Elevation)
#max(POTR_site$Elevation)
#summary(POTR_site$Elevation)
```



#substrate tallies and chi-sq
```{r}
count(ash)
count(bryophyte)
count(litter)
count(mineral)
count(rock)
count(wood)

substrate_counts = c(224, 256, 8, 55, 0, 4)
#chisq.test(substrate_counts, correct = F)

```

#topo
```{r}
cc
cv
s
f
CC
CV
S
F
```


#relationships between height and other variables
```{r}
#height and substrate
kruskal.test(Height..cm. ~ Substrate, data = compiled)

library(FSA)
dunnTest(Height..cm. ~ Substrate, data = compiled, method = "holm")

#height and cluster
kruskal.test(Height..cm. ~ SITE.NAME, data = compiled)

dunnTest(Height..cm. ~ SITE.NAME, data = compiled, method = "holm")

#height and elevation

kruskal.test(Height..cm. ~ Elevation, data = compiled)

dunnTest(Height..cm. ~ Elevation, data = compiled, method = "holm")

#small topo and height

kruskal.test(Height..cm. ~ Small.Topo, data = compiled)

dunnTest(Height..cm. ~ Small.Topo, data = compiled, method = "holm")

#large topo and height

kruskal.test(Height..cm. ~ Large.Topo, data = compiled)

dunnTest(Height..cm. ~ Large.Topo, data = compiled, method = "holm")


```

#Kruskall tests with seedling count
```{r}
#count and cluster
kruskal.test(seedling ~ SITE.NAME, data = compiled)

dunnTest(seedling ~ SITE.NAME, data = compiled, method = "holm")

#count and elevation

kruskal.test(seedling ~ Elevation, data = compiled)

dunnTest(seedling ~ Elevation, data = compiled, method = "holm")

#count and topo 

kruskal.test(seedling ~ Small.Topo, data = compiled)

dunnTest(seedling ~ Small.Topo, data = compiled, method = "holm")


#count topo and height

kruskal.test(seedling ~ Large.Topo, data = compiled)

dunnTest(seedling ~ Large.Topo, data = compiled, method = "holm")
```


#substrate
```{r}
ash
bryophyte
litter
mineral
rock
wood
```




#elevation hist
```{r}
low
moderate
high
hist(compiled$Elevation, breaks = 10, col = "light blue", main = "Elevation range of seedlings across all sites", xlab = "Elevation (m)", ylab = "Frequency")
```
#browse and CWD

```{r}
#by large CWD
Lcwdp 
Lcwda 

#by small CWD
Scwdp 
Scwda 
```

#all regen
```{r}
#REGEN
abla <- REGEN %>% filter(ABLA > "0")
pico <- REGEN %>% filter(PICO > "0")
pien <- REGEN %>% filter(PIEN > "0")
pipo <- REGEN %>% filter(PIPO > "0")
psme <- REGEN %>% filter(PSME > "0")

sucker_regen <- REGEN %>% filter(POTR..sucker. > "0")

abla
pico
pien
pipo
psme
sucker_regen
```

#other aspen
```{r}
sucker <- compiled %>% filter(Sucker.Dist. < "51")
parent <- compiled %>% filter(Distance.to.nearest.live.aspen < "51")
orphan <- compiled %>% filter(Distance.to.nearest.dead.aspen < "51")

parent
orphan

```
#browse
```{r}
browse <- compiled %>% filter(Browse == "1")
no_browse <- compiled %>% filter(Browse == "0")

browse
tapply(browse$Height..cm., browse$SITE.., summary)
```

```{r}
compiled
seedling_count_cluster
```

```{r}
TransectCount <- count(compiled, compiled$Transect)
```

#how to set up binomial linear mixed model??
```{r}
n <- 38
id <- seq(n)
transect <- 1:2
d <- expand.grid(id = id, transect=transect)
set.seed(1)
#sect <- sample(c("A", "B"), size = n, replace = TRUE)
cluster <- sample(c("Blue", "Cam", "CR69", "Elkhorn", "Fish", "Lake", "Long", "Monty", "Rawah", "Res", "Snow"), size = n, replace = TRUE)
d$cluster <- cluster[d$id]
#d$sect <- sect[d$id]
d <- d[order(d$id, d$transect),]
rownames(d) <- NULL
head(d, n = 76)
```

Probabilities of seedling presence:
```{r}
#Blue p = 
#Cam
#CR
#Elk
#Fish
#Lake
#Long
#Monty
#Rawah
#Res
#Snow



d$clusterint <- interaction(d$cluster)
probs <- c()
```

#Visualizing abnormality
```{r}
#hist(seedling_count_cluster$n)
#hist(seedling_count$n)
#hist(compiled$Height..cm.)
```





















